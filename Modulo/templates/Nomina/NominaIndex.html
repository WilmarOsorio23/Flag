{# Modulo/templates/Nomina/nomina_index.html #}
{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block titulo %} Lista de Nómina {% endblock %}

{% block contenido %}
<style>
  .compact-table td, .compact-table th { vertical-align: middle; }
  .emp-start { border-top: 2px solid rgba(0,0,0,.08); }
  .cell-muted { color: rgba(0,0,0,.55); font-size: .85rem; }
  .modal-xl { max-width: 1100px; }
</style>

<div class="card">

  <div class="card-header d-flex justify-content-between align-items-center">
    <h4 class="card-title">Nómina</h4>
  </div>

  <div class="card-body">
    <div class="button-group">
      <a class="btn btn-outline-primary fas fa-plus-circle"
         title="Crear"
         href="{% url 'nomina_crear' %}"
         role="button"></a>

      <a id="edit-button"
         class="btn btn-outline-primary fas fa-edit"
         title="Editar"
         href="#"
         role="button"
         onclick="enableEdit();"></a>

      <i class="btn btn-outline-primary fas fa-eye"
         title="Visualizar"
         role="button"
         style="margin-right: 10px;"></i>

      <!-- NUEVO: Copiar mes -->
      <button type="button"
              class="btn btn-outline-secondary fas fa-copy"
              title="Copiar mes"
              data-bs-toggle="modal"
              data-bs-target="#bulkCopyModal"></button>

      <button type="submit"
              form="delete-form"
              class="btn btn-outline-danger fas fa-trash-alt"
              title="Eliminar">
      </button>

      <form id="download-form"
            method="POST"
            action="{% url 'nomina_descargar_excel' %}"
            style="display:inline;">
        {% csrf_token %}
        <input type="hidden" name="items_to_download" id="items_to_download">
        <button type="submit"
                class="btn btn-outline-info fas fa-download"
                title="Descargar"></button>
      </form>

      <button id="save-button"
              class="btn btn-outline-success fas fa-save d-none"
              title="Guardar"
              type="button"
              onclick="saveRow();">
      </button>

      <button id="cancel-button"
              class="btn btn-outline-danger fas fa-times d-none"
              title="Cancelar"
              type="button"
              onclick="cancelEdit();">
      </button>
    </div>
  </div>

  <div class="card-footer text-muted">
    <div class="table-responsive">
      <form id="delete-form" method="POST" action="{% url 'nomina_eliminar' %}">
        {% csrf_token %}
        <table class="table table-primary compact-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>Año</th>
              <th>Mes</th>
              <th>Nombre Empleado</th>
              <th>Salario</th>
              <th>Cliente</th>
            </tr>
          </thead>

          <tbody>
            {% for row in nomina_rows %}
              <tr id="row-{{ row.nomina.NominaId }}" class="{% if row.is_group_start %}emp-start{% endif %}">
                <td>
                  <input type="checkbox"
                         class="row-select"
                         name="items_to_delete"
                         value="{{ row.nomina.NominaId }}">
                </td>

                {% if row.show_year %}
                  <td data-field="anio" class="text-start" rowspan="{{ row.year_rowspan }}">
                    <div class="fw-semibold">{{ row.nomina.Anio }}</div>
                  </td>
                {% endif %}

                <td data-field="mes" class="text-start">
                  <span class="form-control-plaintext">{{ row.nomina.Mes }}</span>
                </td>

                {% if row.show_doc %}
                  <td data-field="documento" class="text-start" rowspan="{{ row.doc_rowspan }}">
                    <div class="fw-semibold">{{ row.nomina.Documento.Nombre }}</div>
                    <div class="cell-muted">{{ row.nomina.Documento.Documento }}</div>
                  </td>
                {% endif %}

                <td data-field="salario" class="text-end">
                  <span class="form-control-plaintext">
                    {{ row.nomina.Salario|currency_format }}
                  </span>
                  <input type="text"
                         name="salario"
                         class="form-control d-none"
                         value="{{ row.nomina.Salario }}"
                         readonly>
                </td>

                <td data-field="cliente" class="text-start">
                  <select name="Cliente"
                          class="form-control-plaintext"
                          disabled>
                    {% for cliente in form.fields.Cliente.queryset %}
                      <option value="{{ cliente.ClienteId }}"
                              {% if row.nomina.Cliente.ClienteId == cliente.ClienteId %}selected{% endif %}>
                        {{ cliente.Nombre_Cliente }}
                      </option>
                    {% endfor %}
                  </select>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </form>
    </div>
  </div>

  <!-- Modal confirmación borrado -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteLabel">Confirmar eliminación</h5>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          ¿Estás seguro de que deseas eliminar los registros seleccionados de nómina?
        </div>
        <div class="modal-footer">
          <button type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">No</button>
          <button id="confirm-delete-btn"
                  type="button"
                  class="btn btn-danger">Sí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================================================== -->
  <!-- NUEVO: Modal Copiar Mes (origen -> destino) -->
  <!-- ===================================================== -->
  <div class="modal fade" id="bulkCopyModal" tabindex="-1" aria-labelledby="bulkCopyLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bulkCopyLabel">Copiar nómina por mes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="p-3 border rounded">
                <div class="fw-semibold mb-2">Origen</div>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label">Año</label>
                    <input id="bulk-origin-year" type="number" class="form-control" placeholder="2026">
                  </div>
                  <div class="col-6">
                    <label class="form-label">Mes</label>
                    <input id="bulk-origin-month" type="number" class="form-control" min="1" max="12" placeholder="1-12">
                  </div>
                </div>
                <button id="bulk-load-btn" type="button" class="btn btn-outline-primary mt-3">
                  Cargar origen
                </button>
                <div class="small text-muted mt-2">
                  Esto trae las filas del período origen para editarlas antes de crear el destino.
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="p-3 border rounded">
                <div class="fw-semibold mb-2">Destino</div>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label">Año</label>
                    <input id="bulk-dest-year" type="number" class="form-control" placeholder="2026">
                  </div>
                  <div class="col-6">
                    <label class="form-label">Mes</label>
                    <input id="bulk-dest-month" type="number" class="form-control" min="1" max="12" placeholder="1-12">
                  </div>
                </div>

                <div class="mt-3">
                  <label class="form-label">Si ya existe en destino (mismo empleado)</label>
                  <select id="bulk-mode" class="form-select">
                    <option value="skip" selected>Omitir (skip)</option>
                    <option value="overwrite">Sobrescribir (overwrite)</option>
                  </select>
                </div>

                <button id="bulk-create-btn" type="button" class="btn btn-success mt-3" disabled>
                  Crear en destino
                </button>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <!-- plantilla oculta para opciones de cliente -->
          <select id="bulk-client-template" class="d-none">
            {% for cliente in form.fields.Cliente.queryset %}
              <option value="{{ cliente.ClienteId }}">{{ cliente.Nombre_Cliente }}</option>
            {% endfor %}
          </select>

          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead>
                <tr>
                  <th style="width:40px;">
                    <input type="checkbox" id="bulk-select-all" checked>
                  </th>
                  <th>Empleado</th>
                  <th style="width:180px;">Salario</th>
                  <th>Cliente</th>
                </tr>
              </thead>
              <tbody id="bulk-preview-body">
                <tr>
                  <td colspan="4" class="text-muted">
                    Carga un origen para ver el preview aquí.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div id="bulk-summary" class="small text-muted mt-2"></div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script src=\"{% static 'JS/Nomina.js' %}\"></script>
{% endblock %}
