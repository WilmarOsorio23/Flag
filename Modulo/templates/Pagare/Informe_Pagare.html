{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block titulo %}Informe de Pagarés{% endblock %}

{% block estilos %}
<style>
  .report-wrap { background: #f6f8fb; padding: 14px; border-radius: 14px; }
  .report-card { border: 0; border-radius: 16px; box-shadow: 0 10px 30px rgba(16,24,40,.06); overflow: hidden; }
  .report-header { background: linear-gradient(180deg, #0d6efd 0%, #0b5ed7 100%); color: #fff; }
  .report-header .sub { opacity: .85; }
  .chip { display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; border-radius: 999px; background: rgba(255,255,255,.16); color:#fff; font-size:.85rem; }
  .filters-card { border: 1px solid rgba(16,24,40,.08); border-radius: 14px; background:#fff; }
  .filters-grid .dropdown-menu { max-height: 320px; overflow:auto; }
  .dropdown-item label { white-space: normal; cursor:pointer; }
  .table thead th { position: sticky; top: 0; z-index: 2; }
  .table thead th { background: #0d6efd !important; color: #fff; }
  .sortable { cursor: pointer; user-select:none; }
  .sort-icon i { display:none; }
  .sort-icon .sort-icon-default { display:inline; opacity:.9; }
  .fila-cumplida { background: #d9fbe1 !important; }
  .badge-soft { background:#eef2ff; color:#3730a3; border:1px solid rgba(55,48,163,.15); }
  .btn-round { border-radius: 12px; }
</style>
<style>
  /* 1) No recortar dropdowns por la tarjeta */
  .report-card { overflow: visible !important; }

  /* 2) Asegurar que los dropdowns de filtros tengan scroll y no recorten contenido */
  #informe-pagares-app .filters-card .dropdown-menu{
    max-height: 360px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    white-space: normal !important;
    z-index: 2000 !important;
  }

  /* 3) Permitir que el texto haga wrap y no se salga */
  #informe-pagares-app .filters-card .dropdown-item,
  #informe-pagares-app .filters-card .dropdown-item label{
    white-space: normal !important;
  }

  #informe-pagares-app .filters-card .dropdown-item label{
    display: flex;
    align-items: flex-start;
    gap: .5rem;
  }

  #informe-pagares-app .filters-card .dropdown-item label span{
    flex: 1;
    min-width: 0;
    word-break: break-word;
  }
</style>
{% endblock %}

{% block contenido %}
<div class="report-wrap" id="informe-pagares-app" data-fecha-actual="{{ fecha_actual }}">
  <div class="card report-card">
    <div class="card-header report-header d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h4 class="mb-0">Informe de Pagarés</h4>
        <div class="sub small">Filtra, revisa y exporta pagarés con detalle de cuotas.</div>
      </div>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="chip"><i class="fas fa-calendar-alt"></i> {{ fecha_actual }}</span>
        {% if show_data %}
          <span class="chip"><i class="fas fa-list"></i> {{ pagares_info|length }} registros</span>
        {% endif %}
      </div>
    </div>

    <div class="card-body">

      <div class="filters-card p-3 mb-3">
        <form method="GET" id="filterForm">
          <div class="row g-2 filters-grid align-items-end">
            <div class="col-12 col-lg-3">
              <label class="form-label fw-semibold">{{ form.empleados_con_pagare.label }}</label>
              <div class="dropdown">
                <button
                  class="btn btn-outline-primary dropdown-toggle w-100 btn-round"
                  type="button"
                  id="dropdownEmpleados"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  data-selected-text="Seleccione Empleados">
                  Seleccione Empleados
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownEmpleados">
                  {% for checkbox in form.empleados_con_pagare %}
                    <li class="dropdown-item">
                      <label class="form-check-label">
                        {{ checkbox.tag }} <span class="ms-2">{{ checkbox.choice_label|safe }}</span>
                      </label>
                    </li>
                  {% endfor %}
                </ul>
              </div>
              <div class="form-text">Tip: selecciona uno o varios.</div>
            </div>

            <div class="col-12 col-lg-2">
              <label class="form-label fw-semibold">{{ form.Anio.label }}</label>
              <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle w-100 btn-round"
                        type="button" id="dropdownAnio" data-bs-toggle="dropdown"
                        aria-expanded="false" data-selected-text="Todos">
                  Todos
                </button>
                <ul class="dropdown-menu w-100" aria-labelledby="dropdownAnio">
                  {% for value, label in form.Anio.field.choices %}
                    <li class="dropdown-item">
                      <label class="form-check-label w-100">
                        <input type="radio" name="Anio" value="{{ value }}" {% if form.Anio.value == value %}checked{% endif %}>
                        <span class="ms-2">{{ label }}</span>
                      </label>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>

            <div class="col-12 col-lg-2">
              <label class="form-label fw-semibold">{{ form.LineaId.label }}</label>
              <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle w-100 btn-round"
                        type="button" id="dropdownLinea" data-bs-toggle="dropdown"
                        aria-expanded="false" data-selected-text="Todas">
                  Todas
                </button>
                <ul class="dropdown-menu w-100" aria-labelledby="dropdownLinea">
                  {% for checkbox in form.LineaId %}
                    <li class="dropdown-item">
                      <label class="form-check-label w-100">
                        {{ checkbox.tag }} <span class="ms-2">{{ checkbox.choice_label }}</span>
                      </label>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label fw-semibold">{{ form.tipo_pagare.label }}</label>
              <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle w-100 btn-round"
                        type="button" id="dropdownTipoPagare" data-bs-toggle="dropdown"
                        aria-expanded="false" data-selected-text="Todos">
                  Todos
                </button>
                <ul class="dropdown-menu w-100" aria-labelledby="dropdownTipoPagare">
                  {% for checkbox in form.tipo_pagare %}
                    <li class="dropdown-item">
                      <label class="form-check-label w-100">
                        {{ checkbox.tag }} <span class="ms-2">{{ checkbox.choice_label }}</span>
                      </label>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>

            <div class="col-12 col-lg-2">
              <label class="form-label fw-semibold">{{ form.estado_pagare.label }}</label>
              <select class="form-select btn-round" name="estado_pagare" id="estado_pagare">
                {% for value, label in form.estado_pagare.field.choices %}
                  <option value="{{ value }}" {% if form.estado_pagare.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
            <div class="d-flex gap-2">
              <button type="submit" name="buscar" class="btn btn-primary btn-round">
                <i class="fas fa-search me-1"></i> Buscar
              </button>

              <a href="{% url 'informe_pagares' %}" class="btn btn-outline-secondary btn-round" id="btnLimpiar">
                <i class="fas fa-broom me-1"></i> Limpiar
              </a>
            </div>

            <button type="button" id="btnExportar" class="btn btn-success btn-round">
              <i class="fas fa-file-excel me-1"></i> Exportar
            </button>
          </div>
        </form>
      </div>

      {% if show_data %}
        <div class="table-responsive">
          <table class="table table-bordered table-hover table-sm align-middle" id="tablaPagares">
            <thead>
              <tr>
                <th style="width:42px;"><input type="checkbox" id="selectAll"></th>

                <th data-sort="documento" class="sortable" data-direction="default">
                  Documento
                  <span class="sort-icon">
                    <i class="fas fa-sort sort-icon-default"></i>
                    <i class="fas fa-sort-up sort-icon-asc"></i>
                    <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>
                </th>

                <th data-sort="nombre" class="sortable" data-direction="default">
                  Nombre
                  <span class="sort-icon">
                    <i class="fas fa-sort sort-icon-default"></i>
                    <i class="fas fa-sort-up sort-icon-asc"></i>
                    <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>
                </th>

                <th data-sort="tipo_pagare" class="sortable" data-direction="default">Tipo</th>
                <th data-sort="descripcion" class="sortable" data-direction="default">Descripción</th>
                <th data-sort="estado" class="sortable" data-direction="default">Estado</th>
                <th data-sort="linea" class="sortable" data-direction="default">Línea</th>
                <th data-sort="cargo" class="sortable" data-direction="default">Cargo</th>
                <th data-sort="fecha_ingreso" class="sortable" data-direction="default">F. Ingreso</th>
                <th data-sort="fecha_inicio" class="sortable" data-direction="default">F. Inicio Op.</th>
                <th data-sort="consecutivo" class="sortable" data-direction="default">Consecutivo</th>
                <th data-sort="fecha_pagare" class="sortable" data-direction="default">F. Pagaré</th>
                <th data-sort="fecha_inicio_cond" class="sortable" data-direction="default">Inicio Cond.</th>
                <th data-sort="fecha_fin_cond" class="sortable" data-direction="default">Fin Cond.</th>
                <th data-sort="valor" class="sortable" data-direction="default">Valor</th>
                <th data-sort="valor_cond" class="sortable" data-direction="default">Valor Cond.</th>
                <th data-sort="deuda" class="sortable" data-direction="default">Deuda</th>
                <th data-sort="meses_cond" class="sortable" data-direction="default">Meses</th>
                <th data-sort="cond_hechos" class="sortable" data-direction="default">Cond. Hechos</th>
                <th data-sort="por_cond" class="sortable" data-direction="default">Por Cond.</th>
                <th data-sort="ejecucion" class="sortable" data-direction="default">% Ejec.</th>
                <th data-sort="fecha_retiro" class="sortable" data-direction="default">F. Retiro</th>
              </tr>
            </thead>

            <tbody>
              {% for registro in pagares_info %}
                <tr class="{% if registro.MesesCondonacion and registro.MesesPorCondonar == 0 %}fila-cumplida{% endif %}">
                  <td>
                    <input type="checkbox"
                           name="selected_pagares"
                           value="{{ registro.ConsecutivoPagare }}"
                           data-valor="{{ registro.ValorPagare }}"
                           data-meses="{{ registro.MesesCondonacion }}"
                           data-fecha="{{ registro.FechaInicioCondonacion|default:'' }}"
                           data-documento="{{ registro.Documento }}"
                           data-nombre="{{ registro.Nombre }}">
                  </td>

                  <td data-field="documento" class="text-end">{{ registro.Documento }}</td>
                  <td data-field="nombre" class="text-start">{{ registro.Nombre }}</td>
                  <td data-field="tipo_pagare" class="text-start">{{ registro.TipoPagare }}</td>
                  <td data-field="descripcion" class="text-start">{{ registro.Descripcion }}</td>

                  <td data-field="estado" class="text-start">
                    <span class="badge badge-soft">{{ registro.Estado }}</span>
                  </td>

                  <td data-field="linea" class="text-start">{{ registro.Linea }}</td>
                  <td data-field="cargo" class="text-start">{{ registro.Cargo }}</td>

                  <td data-field="fecha_ingreso" class="text-end">{{ registro.FechaIngreso|default:"-" }}</td>
                  <td data-field="fecha_inicio" class="text-end">{{ registro.FechaOperacion|default:"-" }}</td>

                  <td data-field="consecutivo" class="text-end">{{ registro.ConsecutivoPagare }}</td>
                  <td data-field="fecha_pagare" class="text-end">{{ registro.FechaPagare|default:"-" }}</td>

                  <td data-field="fecha_inicio_cond" class="text-end">{{ registro.FechaInicioCondonacion|default:"-" }}</td>
                  <td data-field="fecha_fin_cond" class="text-end">{{ registro.FechaFinCondonacion|default:"-" }}</td>

                  <td data-field="valor" class="text-end">$ {{ registro.ValorPagare|currency_format }}</td>
                  <td data-field="valor_cond" class="text-end">$ {{ registro.ValorCondonado|currency_format }}</td>
                  <td data-field="deuda" class="text-end">$ {{ registro.DeudaPagare|currency_format }}</td>

                  <td data-field="meses_cond" class="text-end">{{ registro.MesesCondonacion }}</td>
                  <td data-field="cond_hechos" class="text-end">{{ registro.MesesCondonados }}</td>
                  <td data-field="por_cond" class="text-end">{{ registro.MesesPorCondonar }}</td>

                  <td data-field="ejecucion" class="text-end">{{ registro.PorcentajeEjecucion|floatformat:2 }}%</td>
                  <td data-field="fecha_retiro" class="text-end">{{ registro.FechaRetiro|default:"-" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card mt-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Detalle de Cuotas</h5>
            <button id="toggleDetalleCuotas" class="btn btn-outline-secondary btn-round btn-sm">
              Ocultar detalle
            </button>
          </div>
          <div class="card-body" id="detalleCuotasCard" style="display:block;">
            <div class="table-responsive">
              <table class="table table-bordered table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Documento</th>
                    <th>Nombre</th>
                    <th class="text-center">No. Cuota</th>
                    <th>Fecha Cuota</th>
                    <th class="text-end">Valor cuota</th>
                    <th class="text-center">Estado</th>
                  </tr>
                </thead>
                <tbody id="detalleCuotasBody">
                  <tr>
                    <td colspan="6" class="text-center text-muted">Seleccione un pagaré para ver el detalle de cuotas</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="small text-muted mt-2">
              Nota: las cuotas se calculan desde “Inicio Condonación”. Si está vacío, no se puede proyectar.
            </div>
          </div>
        </div>

      {% else %}
        <div class="alert alert-warning mt-4">{{ mensaje }}</div>
      {% endif %}
    </div>
  </div>

  <form id="exportForm" method="GET" action="{% url 'exportar_pagares_excel' %}" style="display:none;">
    <input type="hidden" name="selected_ids" id="selectedIdsInput">
    <input type="hidden" name="export_all" id="exportAllInput" value="0">
    <input type="hidden" name="fecha_informe" id="fechaInformeInput" value="{{ fecha_actual }}">
  </form>
</div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'JS/Informe_Pagare.js' %}"></script>
{% endblock %}
