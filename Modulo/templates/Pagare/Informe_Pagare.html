{% extends 'base.html' %}
{% load static %}

{% block titulo %}
  Informe de Pagarés
{% endblock %}

{% block estilos %}
<style>
  .fila-cumplida {
    background-color: rgb(138, 255, 148) !important;
  }
  .dropdown-item label {
    white-space: normal; /* Permitir saltos de línea */
  }
</style>
{% endblock %}

{% block contenido %}
  <div class="card">
    <div class="card-header">
      <h4 class="card-title">Informe de Pagarés</h4>
    </div>
    <div class="card-body">
      <!-- Fecha del sistema -->
      <div class="row mb-3">
        <div class="col-md-3">
          <div class="form-group">
            <label class="form-label">Fecha del sistema:</label>
            <input type="text" class="form-control" value="{{ fecha_actual }}" readonly>
          </div>
        </div>
      </div>
      
      <form method="GET" id="filterForm">
        <div class="row mb-3">
          <div class="col-md-3">
            <label for="empleados_con_pagare" class="form-label">{{ form.empleados_con_pagare.label }}</label>
            <div class="dropdown">
              <button 
                class="btn btn-outline-primary dropdown-toggle w-100" 
                type="button" 
                id="dropdownEmpleados" 
                data-bs-toggle="dropdown" 
                aria-expanded="false"
                data-selected-text="Seleccione Empleados">
                Seleccione Empleados
              </button>
              <ul class="dropdown-menu w-100" aria-labelledby="dropdownEmpleados">
                {% for checkbox in form.empleados_con_pagare %}
                  <li class="dropdown-item">
                    <label class="form-check-label w-100">
                      {{ checkbox.tag }} {{ checkbox.choice_label|safe }}
                    </label>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <div class="col-md-3">
            <label for="Anio" class="form-label">{{ form.Anio.label }}</label>
            <div class="dropdown">
              <button 
                class="btn btn-outline-primary dropdown-toggle w-100" 
                type="button" 
                id="dropdownAnio" 
                data-bs-toggle="dropdown" 
                aria-expanded="false"
                data-selected-text="Seleccione Año">
                Seleccione Año
              </button>
              <ul class="dropdown-menu w-100" aria-labelledby="dropdownAnio">
                {% for value, label in form.Anio.field.choices %}
                  <li class="dropdown-item">
                    <label class="form-check-label w-100">
                      <input type="radio" name="Anio" value="{{ value }}" {% if form.Anio.value == value %}checked{% endif %}>{{ label }}
                    </label>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <div class="col-md-3">
            <label for="LineaId" class="form-label">{{ form.LineaId.label }}</label>
            <div class="dropdown">
              <button 
                class="btn btn-outline-primary dropdown-toggle w-100" 
                type="button" 
                id="dropdownLinea" 
                data-bs-toggle="dropdown" 
                aria-expanded="false"
                data-selected-text="Seleccione Línea">
                Seleccione Línea
              </button>
              <ul class="dropdown-menu w-100" aria-labelledby="dropdownLinea">
                {% for checkbox in form.LineaId %}
                  <li class="dropdown-item">
                    <label class="form-check-label w-100">
                      {{ checkbox.tag }} {{ checkbox.choice_label }}
                    </label>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <div class="col-md-3">
            <label for="tipo_pagare" class="form-label">{{ form.tipo_pagare.label }}</label>
            <div class="dropdown">
              <button 
                class="btn btn-outline-primary dropdown-toggle w-100" 
                type="button" 
                id="dropdownTipoPagare" 
                data-bs-toggle="dropdown" 
                aria-expanded="false"
                data-selected-text="Seleccione Tipo de Pagaré">
                Seleccione Tipo de Pagaré
              </button>
              <ul class="dropdown-menu w-100" aria-labelledby="dropdownTipoPagare">
                {% for checkbox in form.tipo_pagare %}
                  <li class="dropdown-item">
                    <label class="form-check-label w-100">
                      {{ checkbox.tag }} {{ checkbox.choice_label }}
                    </label>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 text-start">
            <button type="submit" name="buscar" class="btn btn-primary">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
          
          <div class="col-md-6 text-end">
            <button type="button" id="btnExportar" class="btn btn-success">
              <i class="fas fa-file-excel"></i> Exportar
            </button>
          </div>
          
        </div>
      </form>

      {% if show_data %}
        <!-- Tabla de resultados principal -->
        <div class="table-responsive mt-4">
          <table class="table table-bordered table-hover table-sm" id="tablaPagares">
            <thead class="table-primary">
              <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th data-sort="documento" class="sortable" data-direction="default">
                  Documento
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>
                </th>
                <th data-sort="nombre" class="sortable" data-direction="default">
                  Nombre
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="tipo_pagare" class="sortable" data-direction="default">
                  Tipo Pagaré
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="descripcion" class="sortable" data-direction="default">
                  Descripción
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th th data-sort="linea" class="sortable" data-direction="default">
                  Línea
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="cargo" class="sortable" data-direction="default">
                  Cargo
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="fecha_ingreso" class="sortable" data-direction="default">
                  F. Ingreso
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="fecha_inicio" class="sortable" data-direction="default">
                  F. Inicio Op.
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="consecutivo" class="sortable" data-direction="default">
                  Consecutivo
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="fecha_pagare" class="sortable" data-direction="default">
                  F. Pagaré
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="fecha_inicio_cond" class="sortable" data-direction="default">
                  F. Inicio Cond.
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="fecha_fin_cond" class="sortable" data-direction="default">
                  F. Fin Cond.
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th  data-sort="valor" class="sortable" data-direction="default">
                  Valor
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="valor_cond" class="sortable" data-direction="default">
                  Valor Cond.
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="deuda" class="sortable" data-direction="default">
                  Deuda
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="meses_cond" class="sortable" data-direction="default">
                  Meses Cond.
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="cond_hechos" class="sortable" data-direction="default">
                  Cond. Hechos
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="por_cond" class="sortable" data-direction="default">
                  Por Cond.
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="ejecucion" class="sortable" data-direction="default">
                  % Ejec.
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
                <th data-sort="fecha_retiro" class="sortable" data-direction="default">
                  F. Retiro
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>                
                </th>
              </tr>
            </thead>
            <tbody>
              {% for registro in pagares_info %}
              <tr>
                  <td><input type="checkbox" name="selected_pagares" value="{{ registro.ConsecutivoPagare }}" 
                      data-valor="{{ registro.ValorPagare }}"
                      data-meses="{{ registro.MesesCondonacion }}"
                      data-fecha="{{ registro.FechaInicioCondonacion|default:'' }}"
                      data-documento="{{ registro.Documento }}"
                      data-nombre="{{ registro.Nombre }}">
                  </td>
                  <td data-field="documento" class="text-end">{{ registro.Documento }}</td>
                  <td data-field="nombre" class="text-start">{{ registro.Nombre }}</td>
                  <td data-field="tipo_pagare" class="text-start">{{ registro.TipoPagare }}</td>
                  <td data-field="descripcion" class="text-start">{{ registro.Descripcion}}</td>
                  <td data-field="linea" class="text-start">{{ registro.Linea }}</td>
                  <td data-field="cargo" class="text-start">{{ registro.Cargo }}</td>
                  <td data-field="fecha_ingreso" class="text-end">{% if registro.FechaIngreso %}{{ registro.FechaIngreso }}{% else %}-{% endif %}</td>
                  <td data-field="fecha_inicio" class="text-end">{% if registro.FechaOperacion %}{{ registro.FechaOperacion }}{% else %}-{% endif %}</td>
                  <td data-field="consecutivo" class="text-end">{{ registro.ConsecutivoPagare }}</td>
                  <td data-field="fecha_pagare" class="text-end">v{% if registro.FechaPagare %}{{ registro.FechaPagare }}{% else %}-{% endif %}</td>
                  <td data-field="fecha_inicio_cond" class="text-end">{% if registro.FechaInicioCondonacion %}{{ registro.FechaInicioCondonacion }}{% else %}-{% endif %}</td>
                  <td data-field="fecha_fin_cond" class="text-end">{% if registro.FechaFinCondonacion %}{{ registro.FechaFinCondonacion }}{% else %}-{% endif %}</td>
                  <td data-field="valor" class="text-end">$ {{ registro.ValorPagare|floatformat:2 }}</td>
                  <td data-field="valor_cond" class="text-end">$ {{ registro.ValorCondonado|floatformat:2 }}</td>
                  <td data-field="deuda" class="text-end">$ {{ registro.DeudaPagare|floatformat:2 }}</td>
                  <td data-field="meses_cond" class="text-end">{{ registro.MesesCondonacion }}</td>
                  <td data-field="cond_hechos" class="text-end">{{ registro.MesesCondonados }}</td>
                  <td data-field="por_cond" class="text-end">{{ registro.MesesPorCondonar }}</td>
                  <td data-field="ejecucion" class="text-end">{{ registro.PorcentajeEjecucion|floatformat:2 }}%</td>
                  <td data-field="fecha_retiro" class="text-end">{% if registro.FechaRetiro %}{{ registro.FechaRetiro|date:"d/m/Y" }}{% else %}-{% endif %}</td>
              </tr>
              {% endfor %}
          </tbody>
          </table>
        </div>


        
        <!-- Tabla de detalle de cuotas - Siempre visible -->
        <div class="card mt-4" >
          <div class="card-header">
            <h5 class="card-title">Detalle de Cuotas</h5>
            <button id="toggleDetalleCuotas" class="btn btn-secondary">
                Detalle
            </button>
          </div>
          <div class="card-body" id="detalleCuotasCard" style="display=block">
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-info">
                  <tr>
                    <th>Documento</th>
                    <th>Nombre</th>
                    <th>No. Cuota</th>
                    <th>Fecha Cuota</th>
                    <th>Valor cuota</th>
                    <th>Estado</th> <!-- Nueva columna para estado -->
                  </tr>
                </thead>
                <tbody id="detalleCuotasBody">
                  <tr>
                    <td colspan="6" class="text-center">Seleccione un pagaré para ver el detalle de cuotas</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Área de depuración para ver los datos -->
        
      {% else %}
        <div class="alert alert-warning mt-4">{{ mensaje }}</div>
      {% endif %}
    </div>
  </div>
  
  <form id="exportForm" method="GET" action="{% url 'exportar_pagares_excel' %}" style="display:none;">
    <input type="hidden" name="selected_ids" id="selectedIdsInput">
    <input type="hidden" name="export_all" id="exportAllInput" value="0">
    <input type="hidden" name="fecha_informe" id="fechaInformeInput" value="{{ fecha_actual }}">
  </form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    
    // Función para convertir fecha a formato YYYYMMDD (numérico)
    function fechaANumero(fecha) {
        const año = fecha.getFullYear();
        const mes = fecha.getMonth() + 1; // Los meses van de 0 a 11
        const dia = fecha.getDate();
        return año * 10000 + mes * 100 + dia;
    }

    // Actualizar etiquetas de dropdown
    function updateDropdownLabel(dropdownId, inputs) {
        const button = document.getElementById(dropdownId);
        const selectedOptions = Array.from(inputs).filter(input => input.checked || input.selected);
        if (selectedOptions.length === 0) {
            button.textContent = button.getAttribute('data-selected-text') || "Seleccione";
        } else if (selectedOptions.length === 1) {
            button.textContent = selectedOptions[0].nextSibling.textContent.trim();
        } else {
            button.textContent = `${selectedOptions.length} seleccionados`;
        }
    }

    // Adjuntar listeners a los dropdowns
    function attachDropdownListeners(dropdownId) {
        const inputs = document.querySelectorAll(`#${dropdownId} ~ .dropdown-menu input, #${dropdownId} ~ .dropdown-menu select`);
        inputs.forEach(input => input.addEventListener('change', () => updateDropdownLabel(dropdownId, inputs)));
        updateDropdownLabel(dropdownId, inputs);
    }

    // Inicializar dropdowns
    attachDropdownListeners('dropdownEmpleados');
    attachDropdownListeners('dropdownAnio');
    attachDropdownListeners('dropdownLinea');
    attachDropdownListeners('dropdownTipoPagare');

    // Eliminar persistencia de selección al filtrar
    const filterForm = document.getElementById('filterForm');
    filterForm.addEventListener('submit', function () {
        const anioDropdown = document.getElementById('dropdownAnio');
        const lineaDropdown = document.getElementById('dropdownLinea');
        const tipoPagareDropdown = document.getElementById('dropdownTipoPagare');

        // Guardar las selecciones actuales en el almacenamiento local (excepto empleados)
        localStorage.setItem('anioSeleccionado', anioDropdown.textContent);
        localStorage.setItem('lineaSeleccionada', lineaDropdown.textContent);
        localStorage.setItem('tipoPagareSeleccionado', tipoPagareDropdown.textContent);
    });

    // Restaurar las selecciones al cargar la página (excepto empleados)
    const anioSeleccionado = localStorage.getItem('anioSeleccionado');
    const lineaSeleccionada = localStorage.getItem('lineaSeleccionada');
    const tipoPagareSeleccionado = localStorage.getItem('tipoPagareSeleccionado');

    if (anioSeleccionado) {
        document.getElementById('dropdownAnio').textContent = anioSeleccionado;
    }
    if (lineaSeleccionada) {
        document.getElementById('dropdownLinea').textContent = lineaSeleccionada;
    }
    if (tipoPagareSeleccionado) {
        document.getElementById('dropdownTipoPagare').textContent = tipoPagareSeleccionado;
    }


    const toggleButton = document.getElementById('toggleDetalleCuotas');
    const detalleCuotasCard = document.getElementById('detalleCuotasCard');

    if (toggleButton && detalleCuotasCard) {
        // Manejar el clic en el botón para mostrar/ocultar
        toggleButton.addEventListener('click', function () {
            if (detalleCuotasCard.style.display === 'none') {
                detalleCuotasCard.style.display = 'block';
                toggleButton.textContent = 'Ocultar Detalle';
            } else {
                detalleCuotasCard.style.display = 'none';
                toggleButton.textContent = 'Mostrar Detalle';
            }
        });
    }

    // Verificar si el elemento existe antes de agregar el evento
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function () {
            const checkboxes = document.querySelectorAll('input[name="selected_pagares"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }

    // Verificar si los checkboxes existen antes de agregar eventos
    const pagarCheckboxes = document.querySelectorAll('input[name="selected_pagares"]');
    if (pagarCheckboxes.length > 0) {
        pagarCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const checkboxes = document.querySelectorAll('input[name="selected_pagares"]');
                checkboxes.forEach(cb => {
                    if (cb !== this) cb.checked = false;
                });

                // Generar cuotas para el checkbox seleccionado
                generarCuotas(this);
            });
        });
    }

    // Seleccionar todos los pagarés
    
    
    // Exportar a Excel
    document.getElementById('btnExportar').addEventListener('click', function() {
      const selectedCheckboxes = document.querySelectorAll('input[name="selected_pagares"]:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
      
      const fechaInput = document.getElementById('fechaInformeInput');
      fechaInput.value = "{{ fecha_actual }}";
      
      if (selectedIds.length > 0) {
          document.getElementById('selectedIdsInput').value = selectedIds.join(',');
          document.getElementById('exportAllInput').value = "0";
      } else {
          document.getElementById('selectedIdsInput').value = '';
          document.getElementById('exportAllInput').value = "1";
      }
      
      document.getElementById('exportForm').submit();
  });

    // Función para generar las cuotas y mostrar datos de depuración
    function generarCuotas(checkbox) {
      const cuerpoTabla = document.getElementById('detalleCuotasBody');
      cuerpoTabla.innerHTML = '';
  
      if (checkbox.checked) {
          // Obtener datos del pagaré seleccionado
          const valorPagare = parseFloat(checkbox.dataset.valor) || 0;
          const mesesCondonacion = parseInt(checkbox.dataset.meses) || 0;
          const fechaInicioCondonacionStr = checkbox.dataset.fecha || '';
          const documento = checkbox.dataset.documento || 'N/A';
          const nombre = checkbox.dataset.nombre || 'N/A';
  
          let fechaInicio = null;
  
          // Intentar parsear la fecha de inicio de condonación
          if (fechaInicioCondonacionStr) {
              try {
                  const [year, month, day] = fechaInicioCondonacionStr.split('-').map(Number);
                  fechaInicio = new Date(year, month - 1, day);
              } catch (error) {
                  console.error("Error al parsear la fecha de inicio condonación:", error);
                  fechaInicio = null;
              }
          }
  
          const isFechaValida = fechaInicio && !isNaN(fechaInicio.getTime());
  
          console.log('Datos del pagaré seleccionado:', {
              valorPagare,
              mesesCondonacion,
              fechaInicioCondonacionStr,
              documento,
              nombre,
              fechaInicio,
              isFechaValida
          });
  
          if (valorPagare > 0 && mesesCondonacion > 0) {
              const valorCuota = valorPagare / mesesCondonacion;
  
              // Obtener fecha actual
              const fechaActual = new Date();
              fechaActual.setHours(0, 0, 0, 0);
  
              for (let i = 1; i <= mesesCondonacion; i++) {
                  // Crear fila
                  const rowCuota = document.createElement('tr');
  
                  let fechaCuota = null;
                  let fechaFormateada = '-';
                  let estado = '-';
  
                  // Calcular fecha de cuota si la fecha de inicio es válida
                  if (isFechaValida) {
                      fechaCuota = new Date(fechaInicio);
                      fechaCuota.setMonth(fechaInicio.getMonth() + i - 1);
  
                      // Formatear fecha para mostrar
                      fechaFormateada = `${fechaCuota.getDate().toString().padStart(2, '0')}/${(fechaCuota.getMonth() + 1).toString().padStart(2, '0')}/${fechaCuota.getFullYear()}`;
  
                      // Determinar estado de la cuota
                      estado = fechaCuota <= fechaActual ? 'Pago' : 'Pendiente';
                  }
  
                  // Generar contenido de la fila
                  rowCuota.innerHTML = `
                      <td>${documento}</td>
                      <td>${nombre}</td>
                      <td class="text-center">${i}</td>
                      <td>${fechaFormateada}</td>
                      <td class="text-right">$ ${valorCuota.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                      <td class="text-center">${estado}</td>
                  `;
                  cuerpoTabla.appendChild(rowCuota);
              }
          } else {
              cuerpoTabla.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Datos inválidos para mostrar cuotas</td></tr>';
          }
      } else {
          cuerpoTabla.innerHTML = '<tr><td colspan="6" class="text-center">Seleccione un pagaré para ver el detalle de cuotas</td></tr>';
      }
    }

    // Mostrar detalle de cuotas al seleccionar un pagaré
    document.querySelectorAll('input[name="selected_pagares"]').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
          // Desmarcar otros checkboxes
          const checkboxes = document.querySelectorAll('input[name="selected_pagares"]');
          checkboxes.forEach(cb => {
              if (cb !== this) cb.checked = false;
          });
  
          // Generar cuotas para el checkbox seleccionado
          generarCuotas(this);
      });
  });
    
    // Generar cuotas para el primer pagaré si existe
    setTimeout(() => {
        const firstCheckbox = document.querySelector('input[name="selected_pagares"]');
        if (firstCheckbox) {
            firstCheckbox.checked = true;
            generarCuotas(firstCheckbox);
        }
    }, 500);
    const table = document.getElementById('tablaPagares');
if (table) {
    const headers = table.querySelectorAll('th.sortable');

    headers.forEach(header => {
        header.addEventListener('click', () => {
            const column = header.getAttribute('data-sort');
            const direction = header.getAttribute('data-direction') || 'asc';
            const newDirection = direction === 'asc' ? 'desc' : 'asc';

            sortTableByColumn(table, column, newDirection);

            // Reset all headers to default
            headers.forEach(h => {
                h.setAttribute('data-direction', 'default');
                h.querySelector('.sort-icon-default').style.display = 'inline';
                h.querySelector('.sort-icon-asc').style.display = 'none';
                h.querySelector('.sort-icon-desc').style.display = 'none';
            });
            
            // Set current header direction
            header.setAttribute('data-direction', newDirection);
            header.querySelector('.sort-icon-default').style.display = 'none';
            header.querySelector(`.sort-icon-${newDirection}`).style.display = 'inline';
        });
    });

    function sortTableByColumn(table, columnName, direction) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Find column index by data-field attribute to be more precise
        const headerCells = Array.from(table.querySelectorAll('thead th'));
        const columnIndex = headerCells.findIndex(th => {
            return th.getAttribute('data-sort') === columnName;
        });
        
        if (columnIndex === -1) return; // Column not found

        rows.sort((a, b) => {
            // Find cells by data-field attribute for more reliable matching
            const cellA = a.querySelector(`td[data-field="${columnName}"]`);
            const cellB = b.querySelector(`td[data-field="${columnName}"]`);
            
            if (!cellA || !cellB) return 0;
            
            // Get the text content, handling different element types
            const getCellText = (cell) => {
                if (cell.querySelector('input, select')) {
                    return cell.querySelector('input, select').value.trim();
                }
                return cell.innerText.trim();
            };
            
            const textA = getCellText(cellA);
            const textB = getCellText(cellB);

            // Numeric comparison
            if (!isNaN(textA) && !isNaN(textB)) {
                return direction === 'asc' ? textA - textB : textB - textA;
            }

            // Date comparison
            if (columnName.includes('fecha') || columnName.includes('fecha')) {
                const dateA = new Date(textA);
                const dateB = new Date(textB);
                if (!isNaN(dateA) && !isNaN(dateB)) {
                    return direction === 'asc' ? dateA - dateB : dateB - dateA;
                }
            }

            // String comparison
            return direction === 'asc' 
                ? textA.localeCompare(textB) 
                : textB.localeCompare(textA);
        });

        // Reattach sorted rows
        rows.forEach(row => tbody.appendChild(row));
    }
}

});
</script>
{% endblock %}