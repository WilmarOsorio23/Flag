{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block titulo %} Indicadores Totales {% endblock %}

{% block css %}
<style>
    /* Contenedor de la tabla con scroll horizontal */
    .table-fixed-columns {
        overflow-x: auto;
        position: relative;
    }

    /* Columnas fijas */
    th.fixed-column,
    td.fixed-column {
        position: sticky;
        background: white;
        z-index: 1;
    }

    th.fixed-column {
        z-index: 3; 
        background: #343a40 !important; 
        color: white;
        left: 0;
    }

    /* Posiciones específicas */
    .fixed-column-1 { left: 0; min-width: 150px; }
    .fixed-column-2 { left: 150px; min-width: 80px; }
    .fixed-column-3 { left: 230px; min-width: 100px; }
</style>
{% endblock %}

{% block contenido %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="card-title">Indicadores de Totales</h4>
    </div>
    <div class="card-body" style="overflow: visible; position: relative;">
        <div class="container-fluid mb-3">
            <form method="GET">
                <div class="row mb-3">
                    <!-- Filtro Año -->
                    <div class="col-md-3">
                        <label for="anio" class="form-label">{{ form.Anio.label }}</label>
                        {{ form.Anio }}
                    </div>
                
                    <!-- Filtro Mes -->
                    <div class="col-md-3">
                        <label for="mes" class="form-label">{{ form.Mes.label }}</label>
                        <div class="dropdown">
                            <button
                                class="btn btn-outline-primary dropdown-toggle w-100"
                                type="button"
                                id="dropdownMes"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                                data-selected-text="Seleccione Meses"
                            >
                                Seleccione Meses
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="dropdownMes">
                                {% for checkbox in form.Mes %}
                                    <li class="dropdown-item">
                                        {{ checkbox.tag }} {{ checkbox.choice_label }}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                
                    <!-- Filtro Línea -->
                    <div class="col-md-3">
                        <label for="linea" class="form-label">{{ form.LineaId.label }}</label>
                        <div class="dropdown">
                            <button
                                class="btn btn-outline-primary dropdown-toggle w-100"
                                type="button"
                                id="dropdownLinea"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                                data-selected-text="Seleccione Líneas"
                            >
                                Seleccione Líneas
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="dropdownLinea">
                                {% for checkbox in form.LineaId %}
                                    <li class="dropdown-item">
                                        {{ checkbox.tag }} {{ checkbox.choice_label }}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Filtro Clientes -->
                    <div class="col-md-3">
                        <label for="linea" class="form-label">{{ form.ClienteId.label }}</label>
                        <div class="dropdown">
                            <button
                                class="btn btn-outline-primary dropdown-toggle w-100"
                                type="button"
                                id="dropdownCliente"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                                data-selected-text="Seleccione Clientes"
                            >
                                Seleccione Líneas
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="dropdownCliente">
                                {% for checkbox in form.ClienteId %}
                                    <li class="dropdown-item">
                                        {{ checkbox.tag }} {{ checkbox.choice_label }}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>     
                                            
                <div class="row container-fluid">
                    <div class="col-md-6 text-start">
                        <button type="submit" name="buscar" class="btn btn-primary">
                            <i class="fas fa-search"></i> Generar
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Pestañas -->
        <ul class="nav nav-tabs justify-content-center mb-4" id="myTab" role="tablist">
            <!-- Primera pestaña -->
            <li class="nav-item w-50" role="presentation">
                <button class="nav-link active w-100 btn btn-light text-primary" id="totales-tab" 
                        data-bs-toggle="tab" data-bs-target="#totales" 
                        type="button" role="tab" aria-controls="totales" aria-selected="true">
                    Totales
                </button>
            </li>
            <!-- Segunda pestaña -->
            <li class="nav-item w-50" role="presentation">
                <button class="nav-link w-100 btn btn-light text-primary" id="lineas-tab" 
                        data-bs-toggle="tab" data-bs-target="#lineas" 
                        type="button" role="tab" aria-controls="lineas" aria-selected="false">
                    Totales por linea
                </button>
            </li>
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="myTabContent">
            <!-- Pestaña de Indicadores -->
            <div class="tab-pane fade show active p-1" id="totales" role="tabpanel" aria-labelledby="totales-tab">
                {% if resultados.general %}
                <!-- Tabla Principal -->
                <form method="POST">
                    {% csrf_token %}
                    <div class="text-end">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar Datos
                        </button>
                    </div>
                    <div class="table-responsive table-fixed-columns">
                        <table class="table table-bordered table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th class="fixed-column fixed-column-1" rowspan="2">Mes</th>
                                    <th class="fixed-column fixed-column-2" rowspan="2">Días</th>
                                    <th class="fixed-column fixed-column-3" rowspan="2">Horas</th>
                                    {% for cliente in Clientes %}
                                        {% with nombre_cliente=cliente.Nombre_Cliente %}
                                        <th colspan="6">{{ nombre_cliente }}</th>
                                        {% endwith %}
                                    {% endfor %}
                                    {% for concepto in Conceptos %}
                                    <th rowspan="2">{{ concepto.Descripcion }}</th>
                                    {% endfor %}
                                    <th rowspan="2">Costo No Op</th>
                                    <th rowspan="2">Costo Vacaciones</th>
                                    <th rowspan="2">Costo Incapacidades</th>
                                    <th rowspan="2">Total Horas</th>
                                </tr>
                                <tr>
                                    {% for cliente in Clientes %}
                                    <th>Trabajado</th>
                                    <th>$ Costo</th>
                                    <th>Facturado</th>
                                    <th>$ Facturado</th>
                                    <th>Pend.Fact</th>
                                    <th>$ Pend.Fact</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Fila para Diciembre del Año Anterior (solo si hay Enero en los meses seleccionados) -->
                                {% if '1' in resultados.general.keys %}
                                <tr class="bg-light diciembre-anterior">
                                    <td class="fixed-column fixed-column-1">Diciembre {{ anio|add:"-1" }}</td>
                                    <td class="fixed-column fixed-column-2">-</td>
                                    <td class="fixed-column fixed-column-3">-</td>
                                    {% for cliente in Clientes %}
                                    <td>
                                        <input type="number" step="0.01"
                                            name="diciembre_trabajado_{{ cliente.ClienteId }}"
                                            value="{{ valores_diciembre|get_item:cliente.ClienteId|default:''|get_item:'trabajado' }}"
                                            class="form-control mb-2"
                                            placeholder="Horas Trabajadas"
                                            data-toggle-target="diciembre_facturado_{{ cliente.ClienteId }}">
                                    </td>
                                    <td>
                                        <input type="number" step="0.01"
                                            name="diciembre_costo_{{ cliente.ClienteId }}"
                                            value="{{ valores_diciembre|get_item:cliente.ClienteId|default:''|get_item:'costo' }}"
                                            class="form-control mb-2"
                                            placeholder="Costo"
                                            data-toggle-target="diciembre_valor_facturado_{{ cliente.ClienteId }}">
                                    </td>
                                    <td>
                                        <input type="number" step="0.01"
                                            name="diciembre_facturado_{{ cliente.ClienteId }}"
                                            value="{{ valores_diciembre|get_item:cliente.ClienteId|default:''|get_item:'facturado' }}"
                                            class="form-control mb-2"
                                            placeholder="Horas Facturadas"
                                            data-toggle-target="diciembre_trabajado_{{ cliente.ClienteId }}">
                                    </td>
                                    <td>
                                        <input type="number" step="0.01"
                                            name="diciembre_valor_facturado_{{ cliente.ClienteId }}"
                                            value="{{ valores_diciembre|get_item:cliente.ClienteId|default:''|get_item:'valor_facturado' }}"
                                            class="form-control"
                                            placeholder="Valor Facturado"
                                            data-toggle-target="diciembre_costo_{{ cliente.ClienteId }}">
                                    </td>
                                    <td>-</td>
                                    <td>-</td>
                                    {% endfor %}
                                    <!-- Celdas vacías para conceptos y totales -->
                                    {% for concepto in Conceptos %}
                                    <td>-</td>
                                    {% endfor %}
                                    <td>-</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                                {% endif %}
                                {% for mes, datos in resultados.general.items|slice:":12" %} 
                                <tr>
                                    <td class="fixed-column fixed-column-1">{{ MESES|get_item:mes }}</td>
                                    <td class="fixed-column fixed-column-2">{{ datos.Dias }}</td>
                                    <td class="fixed-column fixed-column-3">{{ datos.Horas|floatformat:2 }}</td>
                                    
                                    {% for cliente in Clientes %}
                                        {% with c=datos.Clientes|get_item:cliente.Nombre_Cliente %}
                                        <td data-cliente="{{ cliente.Nombre_Cliente }}">{{ c.Trabajado|default:0|floatformat:2 }}</td>
                                        <td data-cliente="{{ cliente.Nombre_Cliente }}">${{ c.Costo|default:0|floatformat:2 }}</td>
                                        <td data-cliente="{{ cliente.Nombre_Cliente }}">{{ c.Facturado.horas|default:0|floatformat:2 }}</td>
                                        <td data-cliente="{{ cliente.Nombre_Cliente }}">${{ c.Facturado.valor|default:0|floatformat:2 }}</td>
                                        <td data-cliente="{{ cliente.Nombre_Cliente }}">{{ c.Pendiente.horas|default:0|floatformat:2 }}</td>
                                        <td data-cliente="{{ cliente.Nombre_Cliente }}">${{ c.Pendiente.valor|default:0|floatformat:2 }}</td>
                                        {% endwith %}
                                    {% endfor %}
                                    
                                    {% for concepto in Conceptos %}
                                        <td>{{ datos.Conceptos_Horas|get_item:concepto.Descripcion|default:0|floatformat:2 }}</td>
                                    {% endfor %}
                                    
                                    <td>${{ datos.totales_mes.costo_no_op|default:0|floatformat:2 }}</td>
                                    <td>${{ datos.totales_mes.costo_vacaciones|default:0|floatformat:2 }}</td>
                                    <td>${{ datos.totales_mes.costo_incapacidades|default:0|floatformat:2 }}</td>
                                    <td>{{ datos.totales_mes.total_horas|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th class="fixed-column fixed-column-1">TOTALES</th>
                                    <th class="fixed-column fixed-column-2 total-dias">{{ resultados.totales.Dias|default:0|floatformat:2 }}</th>
                                    <th class="fixed-column fixed-column-3 total-horas">{{ resultados.totales.Horas|default:0|floatformat:2 }}</th>
                                    {% for cliente in Clientes %}
                                        {% with total=resultados.totales|get_item:cliente.Nombre_Cliente %}
                                        <th class="total-trabajado" data-cliente="{{ cliente.Nombre_Cliente }}">{{ total.Trabajado|default:0|floatformat:2 }}</th>
                                        <th class="total-costo" data-cliente="{{ cliente.Nombre_Cliente }}">${{ total.Costo|default:0|floatformat:2 }}</th>
                                        <th class="total-facturado-horas" data-cliente="{{ cliente.Nombre_Cliente }}">{{ total.Facturado_horas|default:0|floatformat:2 }}</th>
                                        <th class="total-facturado-valor" data-cliente="{{ cliente.Nombre_Cliente }}">${{ total.Facturado_valor|default:0|floatformat:2 }}</th>
                                        <th class="total-pendiente-horas" data-cliente="{{ cliente.Nombre_Cliente }}">{{ total.Pendiente_horas|default:0|floatformat:2 }}</th>
                                        <th class="total-pendiente-valor" data-cliente="{{ cliente.Nombre_Cliente }}">${{ total.Pendiente_valor|default:0|floatformat:2 }}</th>
                                        {% endwith %}
                                    {% endfor %}
                                    {% for concepto in Conceptos %}
                                        <th>{{ resultados.totales.Conceptos_Horas|get_item:concepto.Descripcion|default:0|floatformat:2 }}</th>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <th class="fixed-column fixed-column-1">Dif fact / Tbjo</th>
                                    {% for cliente in Clientes %}
                                        {% with total=resultados.totales|get_item:cliente.Nombre_Cliente %}
                                            <td colspan="4"></td>
                                            <th>{{ total.Dif_Fact_Horas|default:0|floatformat:2 }}</th>
                                            <th>${{ total.Dif_Fact_Valor|default:0|floatformat:2 }}</th>
                                        {% endwith %}
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <th class="fixed-column fixed-column-1">% Margen Bruto</th>
                                    {% for cliente in Clientes %}
                                        {% with total=resultados.totales|get_item:cliente.Nombre_Cliente %}
                                            <td colspan="5"></td>
                                            <th>{{ total.Margen_Bruto|default:0|floatformat:2 }}%</th>
                                        {% endwith %}
                                    {% endfor %}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-warning mt-3">
                        No se encontraron datos con los filtros seleccionados
                    </div>
                    {% endif %}
                </form>
            </div>
            <!-- Pestaña de Totales por Línea -->
            <div class="tab-pane fade p-3" id="lineas" role="tabpanel" aria-labelledby="lineas-tab">
                {% if resultados.lineas %}
                    {% for linea in Lineas %}
                        {% with linea_data=resultados.lineas|get_item:linea.LineaId %}
                            <div class="mb-5">
                                <div class="card-header text-center bg-primary text-white py-2">
                                    {{ linea.Linea }}
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Mes</th>
                                                <th>Días</th>
                                                <th>Horas</th>
                                                <th>Trabajado</th>
                                                <th>$ Costo</th>
                                                <th>Facturado</th>
                                                <th>$ Facturado</th>
                                                <th>Pend.Fact</th>
                                                <th>$ Pend.Fact</th>
                                                <th>Tot Fact</th>
                                                <th>$ Tot Fact</th>
                                                <th>Dif Horas</th>
                                                <th>Dif Valor</th>
                                                <th>% Margen</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for mes, datos in linea_data.general.items %}
                                                <tr>
                                                    <td>{{ MESES|get_item:mes }}</td>
                                                    <td>{{ datos.Dias }}</td>
                                                    <td>{{ datos.Horas|floatformat:2 }}</td>
                                                    <td>{{ datos.Trabajado|default:0|floatformat:2 }}</td>
                                                    <td>${{ datos.Costo|default:0|floatformat:2 }}</td>
                                                    <td>{{ datos.Facturado.horas|default:0|floatformat:2 }}</td>
                                                    <td>${{ datos.Facturado.valor|default:0|floatformat:2 }}</td>
                                                    <td>{{ datos.Pendiente.horas|default:0|floatformat:2 }}</td>
                                                    <td>${{ datos.Pendiente.valor|default:0|floatformat:2 }}</td>
                                                    <td>{{ datos.TotalFacturado.horas|default:0|floatformat:2 }}</td>
                                                    <td>${{ datos.TotalFacturado.valor|default:0|floatformat:2 }}</td>
                                                    <td>{{ datos.Dif_Horas|default:0|floatformat:2 }}</td>
                                                    <td>${{ datos.Dif_Valor|default:0|floatformat:2 }}</td>
                                                    <td>{{ datos.Margen|default:0|floatformat:2 }}%</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th>TOTALES</th>
                                                <th>{{ linea_data.totales.Trabajado|default:0|floatformat:2 }}</th>
                                                <th>${{ linea_data.totales.Costo|default:0|floatformat:2 }}</th>
                                                <th>{{ linea_data.totales.Facturado_horas|default:0|floatformat:2 }}</th>
                                                <th>${{ linea_data.totales.Facturado_valor|default:0|floatformat:2 }}</th>
                                                <th>{{ linea_data.totales.Pendiente_horas|default:0|floatformat:2 }}</th>
                                                <th>${{ linea_data.totales.Pendiente_valor|default:0|floatformat:2 }}</th>
                                                <th>{{ linea_data.totales.TotalFacturado_horas|default:0|floatformat:2 }}</th>
                                                <th>${{ linea_data.totales.TotalFacturado_valor|default:0|floatformat:2 }}</th>
                                                <th>{{ linea_data.totales.Dif_Horas|default:0|floatformat:2 }}</th>
                                                <th>${{ linea_data.totales.Dif_Valor|default:0|floatformat:2 }}</th>
                                                <th>{{ linea_data.totales.Margen|default:0|floatformat:2 }}%</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        {% endwith %}
                    {% endfor %}
                {% else %}
                    <div class="alert alert-warning">No hay datos</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<script>
    const Clientes = JSON.parse('{{ Clientes_json|escapejs|safe }}');
</script>
<script>
    document.querySelectorAll('.table-fixed-columns').forEach(el => {
        el.addEventListener('scroll', () => {
            const stickyCols = el.querySelectorAll('.fixed-column');
            stickyCols.forEach(col => col.style.transform = `translateX(${el.scrollLeft}px)`);
        });
    });
</script>
<script src="{% static 'JS/indicadores_totales.js' %}"></script>
{% endblock %}
