{% extends 'base.html' %}
{% load static %}

{% block titulo %}
  Informe de Empleados
{% endblock %}

{% block contenido %}
  <div class="card">
    <div class="card-header">
      <h4 class="card-title">Informe de Empleados</h4>
    </div>
    <div class="card-body informes-table">
      <div class="container-fluid mb-3">
        <!-- Formulario principal -->
        <form method="GET">
          <!-- Filtros en la parte superior -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label for="Documento">{{ form.Nombre.label }}</label>
              {{ form.Nombre }}
            </div>
            <div class="col-md-3">
              <label for="Linea">{{ form.LineaId.label }}</label>
              {{ form.LineaId }}
            </div>
            <div class="col-md-3">
              <label for="Cargo">{{ form.Cargo.label }}</label>
              {{ form.Cargo }}
            </div>
            <div class="col-md-3">
              <label for="Certificaciones">{{ form.CertificadoSAP.label }}</label>
              {{ form.CertificadoSAP }}
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-3">
              <label for="PerfilId">{{ form.PerfilId.label }}</label>
              {{ form.PerfilId }}
            </div>
            <div class="col-md-3">
              <label for="Activo">{{ form.Activo.label }}</label>
              {{ form.Activo }}
            </div>
          </div>
          <!-- Botones en la parte inferior -->
          <div class="row">
            <div class="col-md-6 text-start">
              <button type="submit" name="buscar" class="btn btn-primary"><i class="fas fa-search"></i> Buscar</button>
              <button type="button" id="btn-reset-filtros" class="btn btn-secondary ms-2">
                <i class="fas fa-redo"></i> Reiniciar
              </button>
            </div>
          </div>
        </form>

        <!-- Apartado para cards -->
        {% if show_data %}
        <div class="mt-4 mb-3">
          <div class="d-flex flex-row flex-nowrap overflow-auto gap-2">

            <!-- Total Empleados -->
            <div class="card shadow-sm p-3 text-info text-start" style="min-width: 220px;">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">{{ total_empleados }}</h5>
                <i class="fas fa-users fa-2x"></i>
              </div>
              <small class="text-muted mt-2 d-block">Total Empleados</small>
            </div>

            <!-- Tarjeta: Empleados Activos/Inactivos -->
            <div class="card shadow-sm p-3" style="min-width: 220px; cursor: pointer;" id="cardActivosInactivos">
              <div class="card-body p-0">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <div class="fw-bold">
                      <span class="text-success">{{ empleados_activos }}</span>
                      /
                      <span class="text-danger">{{ empleados_inactivos }}</span>
                    </div>
                    <small class="text-muted">Activos / Inactivos</small>
                  </div>
                  <i class="fas fa-users fa-2x text-primary"></i>
                </div>
                <div class="progress" style="height: 6px;">
                  {% with total=empleados_activos|add:empleados_inactivos %}
                    {% if total > 0 %}
                      {% widthratio empleados_activos total 100 as porcentaje_activos %}
                      {% widthratio empleados_inactivos total 100 as porcentaje_inactivos %}
                      <div class="progress-bar bg-success" role="progressbar" style="width: {{ porcentaje_activos }}%;" aria-valuenow="{{ porcentaje_activos }}" aria-valuemin="0" aria-valuemax="100"></div>
                      <div class="progress-bar bg-danger" role="progressbar" style="width: {{ porcentaje_inactivos }}%;" aria-valuenow="{{ porcentaje_inactivos }}" aria-valuemin="0" aria-valuemax="100"></div>
                    {% endif %}
                  {% endwith %}
                </div>
              </div>
            </div>

            <!-- Certificados SAP -->
            <div class="card shadow-sm p-3 text-primary text-start" style="min-width: 220px; cursor: pointer;" id="cardCertificadosSAP">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">{{ certificados_sap }}</h5>
                <i class="fas fa-certificate fa-2x"></i>
              </div>
              <small class="text-muted mt-2 d-block">Certificados SAP</small>

              <div class="mt-2">
                <small class="text-muted">Por Línea</small><br>
                {% for linea, total in certificados_sap_por_linea.items %}
                  <span class="text-primary">{{ linea }}: <strong>{{ total }}</strong></span><br>
                {% endfor %}
              </div>
            </div>

            <!-- Otras Certificaciones -->
            <div class="card shadow-sm p-3 text-warning text-start" style="min-width: 220px;" id="cardOtrasCertificaciones">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">{{ otras_certificaciones }}</h5>
                <i class="fas fa-award fa-2x"></i>
              </div>
              <small class="text-muted mt-2 d-block">Otras Certificaciones</small>

              <div class="mt-2">
                <small class="text-muted">Por Línea</small><br>
                {% for linea, total in otras_certificaciones_por_linea.items %}
                  <span class="text-warning">{{ linea }}: <strong>{{ total }}</strong></span><br>
                {% endfor %}
              </div>
            </div>

            <!-- Con Postgrado -->
            <div class="card shadow-sm p-3 text-danger text-start" style="min-width: 220px;" id="cardPostgrados">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">{{ postgrados }}</h5>
                <i class="fas fa-user-graduate fa-2x"></i>
              </div>
              <small class="text-muted mt-2 d-block">Postgrados</small>

              <div class="mt-2">
                <small class="text-muted">Por Línea</small><br>
                {% for linea, total in postgrados_por_linea.items %}
                  <span class="text-danger">{{ linea }}: <strong>{{ total }}</strong></span><br>
                {% endfor %}
              </div>
            </div>

            <!-- Por Módulo -->
            <div class="card shadow-sm p-3 text-info text-start" style="min-width: 220px; cursor: pointer;" id="cardPorModulo">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">{{ modulos_data|length }}</h5>
                <i class="fas fa-puzzle-piece fa-2x"></i>
              </div>
              <small class="text-muted mt-2 d-block">Distribución por Módulo</small>
            </div>

            <!-- Por Perfil -->
            <div class="card shadow-sm p-3 text-info text-start" style="min-width: 220px; cursor: pointer;" id="cardPorPerfil">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">{{ perfiles_data|length }}</h5>
                <i class="fas fa-user-tag fa-2x"></i>
              </div>
              <small class="text-muted mt-2 d-block">Distribución por Perfil</small>
            </div>

            <!-- Por Línea -->
            <div class="card shadow-sm p-3 text-info text-start" style="min-width: 220px; cursor: pointer;" id="cardPorLinea">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">{{ lineas_data|length }}</h5>
                <i class="fas fa-project-diagram fa-2x"></i>
              </div>
              <small class="text-muted mt-2 d-block">Distribución por Línea</small>
            </div>

          </div>
        </div>
        {% endif %}

        <!-- Botón de Descargar Excel -->
        <div class="row">
          <div class="col-md-6 text-end offset-md-6">
            <form id="download-form" method="GET" action="{% url 'exportar_empleados_excel' %}">
              {% csrf_token %}
              <input type="hidden" name="Nombre" value="{{ form.Nombre.value }}" />
              <input type="hidden" name="LineaId" value="{{ form.LineaId.value }}" />
              <input type="hidden" name="Cargo" value="{{ form.Cargo.value }}" />
              <input type="hidden" name="CertificadoSAP" value="{{ form.CertificadoSAP.value }}" />
              <input type="hidden" name="PerfilId" value="{{ form.PerfilId.value }}" />
              <input type="hidden" name="Activo" value="{{ form.Activo.value }}" />
              <button type="submit" class="btn btn-success">
                  <i class="fas fa-file-excel"></i> Descargar Excel
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Tabla con resultados filtrados -->
      {% if show_data %}
        <!-- Mostrar tabla de empleados -->
        <div class="table-responsive" style="max-height: 80vh; overflow: auto;">
          <table class="table table-bordered table-hover table-primary w-100"  id="nominaTable">
            <thead>
              <tr>
                <th data-sort="TipoDocumento" class="sortable" data-direction="default">
                  Tipo Documento
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>
                </th>
                <th data-sort="Documento" class="sortable" data-direction="default">
                  Documento
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>
                </th>
                <th data-sort="Nombre" class="sortable" data-direction="default">
                  Nombre
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>
                </th>
                <th>Fecha Nacimiento</th>
                <th>Fecha Ingreso</th>
                <th>Fecha Operación</th>
                <th data-sort="Modulo" class="sortable" data-direction="default">
                  Módulo
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>
                </th>
                <th data-sort="Perfil" class="sortable" data-direction="default">
                  Perfil
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>
                </th>
                <th data-sort="Linea" class="sortable" data-direction="default">
                  Línea
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>
                </th>
                <th data-sort="Cargo" class="sortable" data-direction="default">
                  Cargo
                  <span class="sort-icon">
                      <i class="fas fa-sort sort-icon-default"></i>
                      <i class="fas fa-sort-up sort-icon-asc"></i>
                      <i class="fas fa-sort-down sort-icon-desc"></i>
                  </span>
                </th>
                <th>Título Profesional</th>
                <th>Fecha Grado</th>
                <th>Universidad</th>
                <th>Profesión Realizada</th>
                <th>Academia SAP</th>
                <th>Certificado SAP</th>
                <th>Otras Certificaciones</th>
                <th>Postgrados</th>
                <th>Activo</th>
                <th>Fecha Retiro</th>
                <th>Dirección</th>
                <th>Ciudad</th>
                <th>Departamento</th>
                <th>Dirección Alterna</th>
                <th>Teléfono 1</th>
                <th>Teléfono 2</th>
              </tr>
            </thead>
            <tbody>
              {% for empleado in empleados_info %}
                <tr>
                  <td class="text-start">{{ empleado.TipoDocumento }}</td>
                  <td class="text-end">{{ empleado.Documento }}</td>
                  <td class="text-start">{{ empleado.Nombre }}</td>
                  <td>{{ empleado.FechaNacimiento|date:'d/m/Y' }}</td>
                  <td>{{ empleado.FechaIngreso|date:'d/m/Y' }}</td>
                  <td>{{ empleado.FechaOperacion|date:'d/m/Y' }}</td>
                  <td class="text-start">{{ empleado.Modulo }}</td>
                  <td class="text-start">{{ empleado.Perfil }}</td>
                  <td class="text-start">{{ empleado.Linea }}</td>
                  <td class="text-start">{{ empleado.CargoId }}</td>
                  <td class="text-start">{{ empleado.TituloProfesional }}</td>
                  <td>{{ empleado.FechaGrado|date:'d/m/Y' }}</td>
                  <td class="text-start">{{ empleado.Universidad }}</td>
                  <td class="text-start">{{ empleado.ProfesionRealizada }}</td>
                  <td>{{ empleado.AcademiaSAP }}</td>
                  <td>{{ empleado.CertificadoSAP }}</td>
                  <td>{{ empleado.OtrasCertificaciones }}</td>
                  <td>{{ empleado.Postgrados }}</td>                  
                  <td>{{ empleado.Activo }}</td>
                  <td>{{ empleado.FechaRetiro|date:'d/m/Y' }}</td>
                  <td class="text-start">{{ empleado.Direccion|default_if_none:"" }}</td>
                  <td class="text-start">{{ empleado.Ciudad|default_if_none:"" }}</td>
                  <td class="text-start">{{ empleado.Departamento|default_if_none:"" }}</td>
                  <td class="text-start">{{ empleado.DireccionAlterna|default_if_none:"" }}</td>
                  <td class="text-end">{{ empleado.Telefono1|default_if_none:"" }}</td>
                  <td class="text-end">{{ empleado.Telefono2|default_if_none:"" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-warning" role="alert">
              {% if not busqueda_realizada %}
                  No se ha realizado ninguna búsqueda aún.
              {% else %}
                  No se encontraron resultados para los filtros aplicados.
              {% endif %}
        </div>
      {% endif %}
        
                
    </div>
  </div>

    <!-- Modal Gráfico Certificados SAP -->
  <div class="modal fade" id="graficoCertificadosSAPModal" tabindex="-1" aria-labelledby="graficoCertificadosSAPLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="graficoCertificadosSAPLabel">Certificados SAP por Línea</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <canvas id="graficoCertificadosSAPCanvas" width="400" height="400"></canvas>
        </div>
      </div>
    </div>
  </div>
    
    <!-- Modal Gráfico Otras Certificaciones -->
  <div class="modal fade" id="graficoOtrasCertificacionesModal" tabindex="-1" aria-labelledby="graficoOtrasCertificacionesLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="graficoOtrasCertificacionesLabel">Otras Certificaciones por Línea</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <canvas id="graficoOtrasCertificacionesCanvas" width="400" height="400"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Gráfico Postgrados -->
  <div class="modal fade" id="graficoPostgradosModal" tabindex="-1" aria-labelledby="graficoPostgradosLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="graficoPostgradosLabel">Postgrados por Línea</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <canvas id="graficoPostgradosCanvas" width="400" height="400"></canvas>
        </div>
      </div>
    </div>
  </div>

  
  <!-- Modal Gráfico Activos/Inactivos -->
  <div class="modal fade" id="graficoActivosInactivosModal" tabindex="-1" aria-labelledby="graficoActivosInactivosLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="graficoActivosInactivosLabel">Distribución Activos / Inactivos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <canvas id="graficoActivosInactivosCanvas" width="400" height="400"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal por Módulo -->
  <div class="modal fade" id="graficoPorModuloModal" tabindex="-1" aria-labelledby="graficoPorModuloLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="graficoPorModuloLabel">Empleados por Módulo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <canvas id="graficoPorModuloCanvas" width="400" height="400"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal por Perfil -->
  <div class="modal fade" id="graficoPorPerfilModal" tabindex="-1" aria-labelledby="graficoPorPerfilLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="graficoPorPerfilLabel">Empleados por Perfil</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <canvas id="graficoPorPerfilCanvas" width="400" height="400"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal por Línea -->
  <div class="modal fade" id="graficoPorLineaModal" tabindex="-1" aria-labelledby="graficoPorLineaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="graficoPorLineaLabel">Empleados por Línea</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <canvas id="graficoPorLineaCanvas" width="400" height="400"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Carga dinámica de datos para los gráficos en JS -->
  {% block extra_js %}
    <!--
      Inserta los datos de etiquetas y valores para los gráficos
      en el DOM como scripts JSON.
      Estos datos luego son leídos desde JavaScript para generar los gráficos.
    -->
    {{ certificados_sap_labels|json_script:"labels-data" }}
    {{ certificados_sap_data|json_script:"values-data" }}

    {{ otras_certificaciones_labels|json_script:"labels-otras" }}
    {{ otras_certificaciones_data|json_script:"values-otras" }}

    {{ postgrados_labels|json_script:"labels-postgrados" }}
    {{ postgrados_data|json_script:"values-postgrados" }}

    {{ activos_inactivos_labels|json_script:"labels-activos" }}
    {{ activos_inactivos_data|json_script:"values-activos" }}

    {{ modulos_labels|json_script:"labels-modulo" }}
    {{ modulos_data|json_script:"values-modulo" }}

    {{ perfiles_labels|json_script:"labels-perfil" }}
    {{ perfiles_data|json_script:"values-perfil" }}

    {{ lineas_labels|json_script:"labels-linea" }}
    {{ lineas_data|json_script:"values-linea" }}

    <!-- Cargar Chart.js desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lógica JS -->
    <script src="{% static 'JS/informes_empleados.js' %}"></script>
  {% endblock %}


{% endblock %}
