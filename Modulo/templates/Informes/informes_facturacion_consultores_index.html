{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block titulo %} Inf Fact Consultores Línea {% endblock %}

{% block contenido %}
<div class="card">
    <div class="card-header">
        <h4 class="card-title">Inf Fact Consultores Línea</h4>
    </div>
    <div class="card-body">
        <div class="container-fluid mb-3">
            <!-- Formulario principal -->
            <form method="GET">
                <div class="row mb-3">
                    <!-- Filtro Año --> 
                    <div class="col-md-3">
                        <label for="{{ form.Anio.id_for_label }}" class="form-label">{{ form.Anio.label }}</label>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle w-100" type="button" id="dropdownAnio" data-bs-toggle="dropdown" aria-expanded="false" data-selected-text="Seleccionar Año">
                                Seleccionar Año
                            </button>
                            <ul class="dropdown-menu w-100">
                                {% for value, label in form.Anio.field.choices %}
                                    <li><a class="dropdown-item anio-option" data-value="{{ value }}">{{ label }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                        <input type="hidden" name="{{ form.Anio.html_name }}" id="selectedAnio">
                    </div>

                    <!-- Filtro Línea -->
                    <div class="col-md-3">
                        <label for="linea" class="form-label">{{ form.LineaId.label }}</label>
                        <div class="dropdown">
                            <button
                                class="btn btn-outline-primary dropdown-toggle w-100"
                                type="button"
                                id="dropdownLinea"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                                data-selected-text="Seleccione Líneas"
                            >
                                Seleccione Líneas
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="dropdownLinea">
                                {% for checkbox in form.LineaId %}
                                    <li class="dropdown-item p-0">
                                       <label style="cursor: pointer; display: block; width: 100%; padding: 0.5rem 1rem; margin: 0;">
                                        {{ checkbox.tag }} {{ checkbox.choice_label }}
                                      </label>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Filtro Mes -->
                    <div class="col-md-3">
                        <label for="mes" class="form-label">{{ form.Mes.label }}</label>
                        <div class="dropdown">
                            <button
                                class="btn btn-outline-primary dropdown-toggle w-100"
                                type="button"
                                id="dropdownMes"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                                data-selected-text="Seleccione Mes"
                            >
                                Seleccione Mes
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="dropdownMes">
                                {% for checkbox in form.Mes %}
                                    <li class="dropdown-item p-0">
                                        <label style="cursor: pointer; display: block; width: 100%; padding: 0.5rem 1rem; margin: 0;">
                                          {{ checkbox.tag }} {{ checkbox.choice_label }}
                                       </label>                                    
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Botón Buscar -->
                    <div class="col-md-3 text-start">
                        <button type="submit" name="buscar" class="btn btn-primary mt-3">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                </div>   
            </form>
        </div>
        
<!-- Botón de Descargar Excel -->
<div class="row">
    <div class="col-md-6 text-start">
        <form method="GET" action="{% url 'reporte_excel_totales_por_mes' %}">
            <input type="hidden" name="Anio" value="{{ form.Anio.value }}">

            {% for linea in form.LineaId.value %}
                <input type="hidden" name="LineaId" value="{{ linea }}">
            {% endfor %}

            {% for mes in form.Mes.value %}
                <input type="hidden" name="Mes" value="{{ mes }}">
            {% endfor %}

            <button type="submit" class="btn btn-success mt-3">
                <i class="fas fa-file-excel"></i> Descargar Excel
            </button>
        </form>
    </div>
</div>
<!-- Tabla de resultados -->
<div class="table-responsive">
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th rowspan="2">Línea</th>
                {% for mes_num, mes_nombre in meses %}
                    <th colspan="4" class="text-center">{{ mes_nombre }}</th>
                {% endfor %}
                <th colspan="4" class="text-center">Total Línea</th>
            </tr>
            <tr>
                {% for mes_num, mes_nombre in meses %}
                    <th>Valor Factura Cliente</th>
                    <th>Valor Cobro</th>
                    <th>Diferencia Bruta</th>
                    <th>% Diferencia</th>
                {% endfor %}
                <th>Valor Factura Cliente</th>
                <th>Valor Cobro</th>
                <th>Diferencia Bruta</th>
                <th>% Diferencia</th>
            </tr>
        </thead>
        <tbody>
            {% for linea in lineas %}
            <tr>
                <td>{{ linea.Linea }}</td>
                {% for mes_num, mes_nombre in meses %}
                    {% with datos|get_item_safe:linea.Linea|get_item_safe:mes_num as valores %}
                        <td>{{ valores.total_factura|floatformat:2|default:"0.00"|currency_format }}</td>
                        <td>{{ valores.total_cobro|floatformat:2|default:"0.00"|currency_format }}</td>
                        <td>{{ valores.total_diferencia|floatformat:2|default:"0.00" }}</td>
                        <td>{{ valores.porcentaje_diferencia|floatformat:2|default:"0.00" }}%</td>
                    {% endwith %}
                {% endfor %}
                {% with total=totales_por_linea|get_item_safe:linea.Linea %}
                    <td>{{ total.total_factura|floatformat:2|default:"0.00"|currency_format }}</td>
                    <td>{{ total.total_cobro|floatformat:2|default:"0.00"|currency_format }}</td>
                    <td>{{ total.total_diferencia|floatformat:2|default:"0.00" }}</td>
                    <td>{{ total.porcentaje_diferencia|floatformat:2|default:"0.00" }}%</td>
                {% endwith %}
            </tr>
            {% endfor %}

            <!-- Fila de totales por mes -->
            <tr class="table-secondary fw-bold">
                <td>Total</td>
                {% for mes_num, mes_nombre in meses %}
                    {% with total_mes=totales_por_mes|get_item_safe:mes_num %}
                        <td>{{ total_mes.total_factura|floatformat:2|default:"0.00"|currency_format }}</td>
                        <td>{{ total_mes.total_cobro|floatformat:2|default:"0.00"|currency_format }}</td>
                        <td>{{ total_mes.total_diferencia|floatformat:2|default:"0.00" }}</td>
                        <td>{{ total_mes.porcentaje_diferencia|floatformat:2|default:"0.00" }}%</td>
                    {% endwith %}
                {% endfor %}
                <td>{{ total_global.total_factura|floatformat:2|default:"0.00"|currency_format }}</td>
                <td>{{ total_global.total_cobro|floatformat:2|default:"0.00"|currency_format }}</td>
                <td>{{ total_global.total_diferencia|floatformat:2|default:"0.00" }}</td>
                <td>{{ total_global.porcentaje_diferencia|floatformat:2|default:"0.00" }}%</td>
            </tr>
        </tbody>
    </table>
</div>
    </div>
</div>

<script src="{% static 'JS/informe_facturacion_consultores.js' %}"></script>

{% endblock %}