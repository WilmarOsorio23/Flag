{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block titulo %} Inf Fact CeCo Clientes {% endblock %}

{% block contenido %}
<div class="card">
    <div class="card-header">
        <h4 class="card-title">Inf Fact CeCo Clientes</h4>
    </div>
    <div class="card-body">
        <div class="container-fluid mb-3">
            <!-- Formulario principal -->
            <form method="GET">
                <div class="row mb-3">
                    <!-- Filtro Año --> 
                    <div class="col-md-3">
                        <label for="{{ form.Anio.id_for_label }}" class="form-label">{{ form.Anio.label }}</label>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle w-100" type="button" id="dropdownAnio" data-bs-toggle="dropdown" aria-expanded="false" data-selected-text="Seleccionar Año">
                                Seleccionar Año
                            </button>
                            <ul class="dropdown-menu w-100">
                                {% for value, label in form.Anio.field.choices %}
                                    <li><a class="dropdown-item anio-option" data-value="{{ value }}">{{ label }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                        <input type="hidden" name="{{ form.Anio.html_name }}" id="selectedAnio">
                    </div>

                    <!-- Filtro Línea -->
                    <div class="col-md-3">
                        <label for="linea" class="form-label">{{ form.LineaId.label }}</label>
                        <div class="dropdown">
                            <button
                                class="btn btn-outline-primary dropdown-toggle w-100"
                                type="button"
                                id="dropdownLinea"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                                data-selected-text="Seleccione Líneas"
                            >
                                Seleccione Líneas
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="dropdownLinea">
                                {% for checkbox in form.LineaId %}
                                    <li class="dropdown-item p-0">
                                       <label style="cursor: pointer; display: block; width: 100%; padding: 0.5rem 1rem; margin: 0;">
                                        {{ checkbox.tag }} {{ checkbox.choice_label }}
                                      </label>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Filtro Mes -->
                    <div class="col-md-3">
                        <label for="mes" class="form-label">{{ form.Mes.label }}</label>
                        <div class="dropdown">
                            <button
                                class="btn btn-outline-primary dropdown-toggle w-100"
                                type="button"
                                id="dropdownMes"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                                data-selected-text="Seleccione Mes"
                            >
                                Seleccione Mes
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="dropdownMes">
                                {% for checkbox in form.Mes %}
                                    <li class="dropdown-item p-0">
                                        <label style="cursor: pointer; display: block; width: 100%; padding: 0.5rem 1rem; margin: 0;">
                                          {{ checkbox.tag }} {{ checkbox.choice_label }}
                                       </label>                                    
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Filtro Consultor -->
                    <div class="col-md-3">
                        <label for="Ceco" class="form-label">{{ form.Ceco.label }}</label>
                        <div class="dropdown">
                            <button
                                class="btn btn-outline-primary dropdown-toggle w-100"
                                type="button"
                                id="dropdownCeco"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                                data-selected-text="Seleccione Ceco"
                            >
                                Seleccione Ceco
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="dropdownCeco">
                                {% for checkbox in form.Ceco %}
                                    <li class="dropdown-item p-0">
                                       <label style="cursor: pointer; display: block; width: 100%; padding: 0.5rem 1rem; margin: 0;">
                                        {{ checkbox.tag }} {{ checkbox.choice_label }}
                                      </label>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Botón Buscar -->
                    <div class="col-md-3 text-start">
                        <button type="submit" name="buscar" class="btn btn-primary mt-3">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                </div>   
            </form>
        </div>
    </div>
    <!-- Tabla de resultados -->
<div class="table-responsive">
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th rowspan="2">Centro de Costos</th>
                <th rowspan="2">Descripción</th>
                <th rowspan="2">Línea</th>
                <th rowspan="2">Módulo</th>
                {% for mes_num, mes_nombre in meses %}
                    <th class="text-center">{{ mes_nombre }}</th>
                {% endfor %}
                <th class="text-center">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for ceco, descripciones in datos.items %}
                {% with ceco_filas=0 %}
                    {% for descripcion, lineas in descripciones.items %}
                        {% for linea, modulos in lineas.items %}
                            {% with ceco_filas=ceco_filas|add:modulos.items|length %}
                            {% endwith %}
                        {% endfor %}
                    {% endfor %}
                {% endwith %}

                {% with ceco_imprimido=False %}
                    {% for descripcion, lineas in descripciones.items %}
                        {% with descripcion_filas=0 %}
                            {% for linea, modulos in lineas.items %}
                                {% with descripcion_filas=descripcion_filas|add:modulos.items|length %}
                                {% endwith %}
                            {% endfor %}
                        {% endwith %}

                        {% with descripcion_imprimida=False %}
                            {% for linea, modulos in lineas.items %}
                                {% with linea_filas=modulos.items|length %}
                                    {% for modulo, meses_data in modulos.items %}
                                        <tr>
                                            {% if not ceco_imprimido %}
                                                <td rowspan="{{ ceco_filas }}">{{ ceco }}</td>
                                                {% with ceco_imprimido=True %}{% endwith %}
                                            {% endif %}

                                            {% if not descripcion_imprimida %}
                                                <td rowspan="{{ descripcion_filas }}">{{ descripcion }}</td>
                                                {% with descripcion_imprimida=True %}{% endwith %}
                                            {% endif %}

                                            {% if forloop.first %}
                                                <td rowspan="{{ linea_filas }}">{{ linea }}</td>
                                            {% endif %}

                                            <td>{{ modulo }}</td>

                                            {% for mes_num, mes_nombre in meses %}
                                                <td>{{ meses_data|get_item_safe:mes_num|get_item_safe:'total_valor'|floatformat:2|default:"0.00" }}</td>
                                            {% endfor %}

                                            <td class="fw-bold">
                                                {{ totales_por_ceco_linea_modulo|get_item_safe:ceco|get_item_safe:linea|get_item_safe:modulo|get_item_safe:'total_valor'|floatformat:2|default:"0.00" }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endwith %}

                                <!-- Totales por línea -->
                                <tr class="table-info">
                                    <td colspan="3" class="text-end fw-bold">Total {{ linea }}</td>
                                    <td></td>
                                    {% for mes_num, mes_nombre in meses %}
                                        <td class="fw-bold">
                                            {{ totales_por_ceco_linea|get_item_safe:ceco|get_item_safe:linea|get_item_safe:mes_num|get_item_safe:'total_valor'|floatformat:2|default:"0.00" }}
                                        </td>
                                    {% endfor %}
                                    <td class="fw-bold">
                                        {{ totales_por_ceco_linea|get_item_safe:ceco|get_item_safe:linea|get_item_safe:'total_valor'|floatformat:2|default:"0.00" }}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endwith %}
                    {% endfor %}
                {% endwith %}

                <!-- Totales por Ceco -->
                <tr class="table-warning">
                    <td colspan="3" class="text-end fw-bold">Total {{ ceco }}</td>
                    <td></td>
                    {% for mes_num, mes_nombre in meses %}
                        <td class="fw-bold">
                            {{ totales_por_ceco|get_item_safe:ceco|get_item_safe:mes_num|get_item_safe:'total_valor'|floatformat:2|default:"0.00" }}
                        </td>
                    {% endfor %}
                    <td class="fw-bold">
                        {{ totales_por_ceco|get_item_safe:ceco|get_item_safe:'total_valor'|floatformat:2|default:"0.00" }}
                    </td>
                </tr>
            {% endfor %}

            <!-- Totales globales -->
            <tr class="table-secondary fw-bold">
                <td colspan="4">Total General</td>
                {% for mes_num, mes_nombre in meses %}
                    <td>{{ totales_por_mes|get_item_safe:mes_num|get_item_safe:'total_valor'|floatformat:2|default:"0.00" }}</td>
                {% endfor %}
                <td>{{ total_global.total_valor|floatformat:2|default:"0.00" }}</td>
            </tr>
        </tbody>
    </table>
</div>
</div>

<script src="{% static 'JS/informe_serv_consultor.js' %}"></script>

{% endblock %}
