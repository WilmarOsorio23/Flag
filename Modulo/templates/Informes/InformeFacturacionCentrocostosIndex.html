{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block titulo %} Inf Fact CeCo {% endblock %}
{% block contenido %}
<div class="card">
    <div class="card-header">
        <h4 class="card-title">Inf Fact CeCo </h4>
    </div>
    
    <div class="card-body">
                <div class="container-fluid mb-3">
                    <!-- Formulario principal -->
                    <form method="GET">
                        <div class="row mb-3">
                            <!-- Filtro Año --> 
                            <div class="col-md-3">
                                <label for="{{ form.Anio.id_for_label }}" class="form-label">{{ form.Anio.label }}</label>
                                <div class="dropdown">
                                    <button class="btn btn-outline-primary dropdown-toggle w-100" type="button" id="dropdownAnio" data-bs-toggle="dropdown" aria-expanded="false" data-selected-text="Seleccionar Año">
                                        Seleccionar Año
                                    </button>
                                    <ul class="dropdown-menu w-100">
                                        {% for value, label in form.Anio.field.choices %}
                                            <li><a class="dropdown-item anio-option" data-value="{{ value }}">{{ label }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <input type="hidden" name="{{ form.Anio.html_name }}" id="selectedAnio">
                            </div>
                            <!-- Filtro Línea -->
                            <div class="col-md-3">
                                <label for="linea" class="form-label">{{ form.LineaId.label }}</label>
                                <div class="dropdown">
                                    <button
                                        class="btn btn-outline-primary dropdown-toggle w-100"
                                        type="button"
                                        id="dropdownLinea"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false"
                                        data-selected-text="Seleccione Líneas"
                                    >
                                        Seleccione Líneas
                                    </button>
                                    <ul class="dropdown-menu w-100" aria-labelledby="dropdownLinea">
                                        {% for checkbox in form.LineaId %}
                                            <li class="dropdown-item p-0">
                                               <label style="cursor: pointer; display: block; width: 100%; padding: 0.5rem 1rem; margin: 0;">
                                                {{ checkbox.tag }} {{ checkbox.choice_label }}
                                              </label>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <!-- Filtro Mes -->
                            <div class="col-md-3">
                                <label for="mes" class="form-label">{{ form.Mes.label }}</label>
                                <div class="dropdown">
                                    <button
                                        class="btn btn-outline-primary dropdown-toggle w-100"
                                        type="button"
                                        id="dropdownMes"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false"
                                        data-selected-text="Seleccione Mes"
                                    >
                                        Seleccione Mes
                                    </button>
                                    <ul class="dropdown-menu w-100" aria-labelledby="dropdownMes">
                                        {% for checkbox in form.Mes %}
                                            <li class="dropdown-item p-0">
                                                <label style="cursor: pointer; display: block; width: 100%; padding: 0.5rem 1rem; margin: 0;">
                                                  {{ checkbox.tag }} {{ checkbox.choice_label }}
                                               </label>                                    
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <!-- Filtro ceco -->
                            <div class="col-md-3">
                                <label for="Ceco" class="form-label">{{ form.Ceco.label }}</label>
                                <div class="dropdown">
                                    <button
                                        class="btn btn-outline-primary dropdown-toggle w-100"
                                        type="button"
                                        id="dropdownCeco"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false"
                                        data-selected-text="Seleccione Ceco"
                                    >
                                        Seleccione Ceco
                                    </button>
                                    <ul class="dropdown-menu w-100" aria-labelledby="dropdownCeco">
                                        {% for checkbox in form.Ceco %}
                                            <li class="dropdown-item p-0">
                                               <label style="cursor: pointer; display: block; width: 100%; padding: 0.5rem 1rem; margin: 0;">
                                                {{ checkbox.tag }} {{ checkbox.choice_label }}
                                              </label>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <!-- Botón Buscar -->
                            <div class="col-md-3 text-start">
                                <button type="submit" name="buscar" class="btn btn-primary mt-3">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>   
                    </form>
                </div>
                
                <!-- Botón de Descargar Excel -->
            <div class="d-flex flex-column gap-3"> 
                <div class="row">
                    <div class="col-md-12">
                        <form method="GET" action="{% url 'descargar_reporte_excel_facturacion_clientes' %}">
                            <input type="hidden" name="Anio" value="{{ form.Anio.value }}">
                            {% for linea in form.LineaId.value %}
                                <input type="hidden" name="LineaId" value="{{ linea }}">
                            {% endfor %}
                            {% for mes in form.Mes.value %}
                                <input type="hidden" name="Mes" value="{{ mes }}">
                            {% endfor %}
                            <button type="submit" class="btn btn-success mt-3">
                                <i class="fas fa-file-excel"></i> Descargar Excel
                            </button>
                        </form>
                    </div>
                </div> 
        <!-- Pestañas -->
        <ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active w-100" id="datos-tab" data-bs-toggle="tab" data-bs-target="#datos" type="button" role="tab" aria-controls="datos" aria-selected="true">
                    Datos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link w-100" id="graficos-tab" data-bs-toggle="tab" data-bs-target="#graficos" type="button" role="tab" aria-controls="graficos" aria-selected="false">
                    Gráficos
                </button>
            </li>
        </ul>
                <div class="tab-content" id="myTabContent">
            <!-- Pestaña de Datos -->
            <div class="tab-pane fade show active" id="datos" role="tabpanel" aria-labelledby="datos-tab">                
                <!-- Tabla de datos -->
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th class="text-center">Centro de Costos</th>
                                <th class="text-center">Descripción</th>
                                <th class="text-center">Línea</th>
                                <th class="text-center">Módulo</th>
                                {% for mes_num, mes_nombre in meses %}
                                    <th class="text-center">{{ mes_nombre }}</th>
                                    <th class="text-center">Costo {{ mes_nombre }}</th>
                                {% endfor %}
                                <th class="text-center">Total Facturado</th>
                                <th class="text-center">Total Costo</th>
                                <th class="text-center">Margen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ceco, descripciones in datos.items %}
                                {% for descripcion, lineas in descripciones.items %}
                                    {% for linea, modulos in lineas.items %}
                                        {% with row_count=modulos.items|length %}
                                        {% for modulo, meses_data in modulos.items %}
                                            <tr>
                                                {% if forloop.first %}
                                                    <!-- Centro de Costos (rowspan) -->
                                                    <td class="text-center align-middle" rowspan="{{ row_count }}">
                                                        {{ ceco }}
                                                    </td>
                                                    
                                                    <!-- Descripción (rowspan) -->
                                                    <td class="text-center align-middle" rowspan="{{ row_count }}">
                                                        {{ descripcion }}
                                                    </td>
                                                    
                                                    <!-- Línea (rowspan) -->
                                                    <td class="text-center align-middle" rowspan="{{ row_count }}">
                                                        {{ linea|default_if_none:"" }}
                                                    </td>
                                                {% endif %}
                                                
                                                <!-- Módulo -->
                                                <td class="text-center">{{ modulo }}</td>
                                                
                                                <!-- Datos por mes - Facturación y Costo -->
                                                {% for mes_num, mes_nombre in meses %}
                                                    <td class="text-center text-nowrap">
                                                        {{ meses_data|get_item:mes_num|get_item:'total_valor'|default:0|floatformat:2 }}
                                                    </td>
                                                    <td class="text-center text-nowrap">
                                                        {{ meses_data|get_item:mes_num|get_item:'costo'|default:0|floatformat:2 }}
                                                    </td>
                                                {% endfor %}
                                                
                                                <!-- Totales por módulo -->
                                                {% with total_facturado_modulo=totales_por_ceco_linea_modulo|get_item:ceco|get_item:linea|get_item:modulo|default:0 %}
                                                {% with total_costo_modulo=costos_por_ceco_modulo|get_item:ceco|get_item:modulo|default:0 %}
                                                {% with margen_modulo=total_facturado_modulo|sub:total_costo_modulo %}
                                                
                                                <td class="text-center text-nowrap fw-bold">
                                                    {{ total_facturado_modulo|floatformat:2 }}
                                                </td>
                                                <td class="text-center text-nowrap fw-bold">
                                                    {{ total_costo_modulo|floatformat:2 }}
                                                </td>
                                                <td class="text-center text-nowrap fw-bold {% if margen_modulo < 0 %}text-danger{% else %}text-success{% endif %}">
                                                    {{ margen_modulo|floatformat:2 }}
                                                </td>
                                                
                                                {% endwith %}
                                                {% endwith %}
                                                {% endwith %}
                                            </tr>
                                        {% endfor %}
                                        
                                        <!-- Fila de total por línea -->
                                        <tr class="table-info">
                                            <td colspan="4" class="text-center fw-bold">Total {{ linea }}</td>
                                            {% for mes_num, mes_nombre in meses %}
                                                <td class="text-center text-nowrap fw-bold">
                                                    {{ totales_por_ceco_linea_mes|get_item:ceco|get_item:linea|get_item:mes_num|default:0|floatformat:2 }}
                                                </td>
                                                <td class="text-center text-nowrap fw-bold">
                                                    <!-- NUEVO: Mostrar costo total por línea y mes -->
                                                    {{ costos_por_ceco_linea_mes|get_item:ceco|get_item:linea|get_item:mes_num|default:0|floatformat:2 }}
                                                </td>
                                            {% endfor %}
                                            
                                            {% with total_facturado_linea=totales_por_ceco_linea|get_item:ceco|get_item:linea|default:0 %}
                                            {% with total_costo_linea=costos_por_ceco_linea|get_item:ceco|get_item:linea|default:0 %}
                                            {% with margen_linea=total_facturado_linea|sub:total_costo_linea %}
                                            
                                            <td class="text-center text-nowrap fw-bold">
                                                {{ total_facturado_linea|floatformat:2 }}
                                            </td>
                                            <td class="text-center text-nowrap fw-bold">
                                                {{ total_costo_linea|floatformat:2 }}
                                            </td>
                                            <td class="text-center text-nowrap fw-bold {% if margen_linea < 0 %}text-danger{% else %}text-success{% endif %}">
                                                {{ margen_linea|floatformat:2 }}
                                            </td>
                                            
                                            {% endwith %}
                                            {% endwith %}
                                            {% endwith %}
                                        </tr>
                                        {% endwith %}
                                    {% endfor %}
                                {% endfor %}
                            {% endfor %}
                            
                            <!-- Fila de total global -->
                            <tr class="table-success">
                                <td colspan="4" class="text-center fw-bold">TOTAL GENERAL</td>
                                {% for mes_num, mes_nombre in meses %}
                                    <td class="text-center text-nowrap fw-bold">
                                        {{ totales_por_mes|get_item:mes_num|default:0|floatformat:2 }}
                                    </td>
                                    <td class="text-center text-nowrap fw-bold">
                                        {{ costos_por_mes|get_item:mes_num|default:0|floatformat:2 }}
                                    </td>
                                {% endfor %}
                                
                                <td class="text-center text-nowrap fw-bold">
                                    {{ total_global|default:0|floatformat:2 }}
                                </td>
                                <td class="text-center text-nowrap fw-bold">
                                    {{ costo_global|default:0|floatformat:2 }}
                                </td>
                                <td class="text-center text-nowrap fw-bold {% if margen_global < 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ margen_global|default:0|floatformat:2 }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pestaña de Gráficos -->
<div class="tab-pane fade p-3" id="graficos" role="tabpanel">
    <div class="row">
        {% for grafico in graficos %}
        <div class="col-12 mb-4">  <!-- Cambiado de col-md-6 a col-12 -->
            <div class="card">
                <div class="card-header text-white py-2 
                    {% if grafico.tipo == 'cecos' %}bg-primary{% else %}bg-success{% endif %}">
                    {{ grafico.nombre }}
                </div>
                <div class="card-body" style="height: 500px; position: relative;">
                    <canvas id="grafico-{{ grafico.tipo }}"></canvas>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script src=\"{% static 'JS/InformeFacturacionCeco.js' %}\"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ graficos|json_script:"graficos-data" }}
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
{% endblock %}
