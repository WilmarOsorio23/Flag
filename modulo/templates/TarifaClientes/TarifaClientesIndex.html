{# Modulo/templates/Tarifa_Clientes/Tarifa_Clientes_Index.html #}
{% extends "Base.html" %}
{% load static %}
{% load custom_filters %}
{% block titulo %} Lista de Tarifas de Clientes {% endblock %}

{% block contenido %}
<div class="card">

    {# Caja inline para mensajes JS (usa messages.js) #}
    <div id="message-box" class="alert alert-dismissible fade" role="alert" style="display:none;">
        <span id="alert-icon" class="alert-heading"></span>
        <span id="alert-message"></span>
    </div>

    {# Mensajes de Django: se dejan ocultos y messages.js los convierte a flotantes #}
    {% if messages %}
    <div class="messages d-none">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="card-title">Tarifa de Clientes</h4>
    </div>

    <div class="card-body">
        <div class="button-group">
            <a class="btn btn-outline-primary fas fa-plus-circle" title="Crear" href="{% url 'tarifa_clientes_crear' %}" role="button"></a>
            <a id="edit-button" class="btn btn-outline-primary fas fa-edit" title="Editar" href="#" role="button" onclick="enableEdit(); return false;"></a>
            <i class="btn btn-outline-primary fas fa-eye" title="Visualizar" role="button" style="margin-right:10px;"></i>

            <button id="delete-button" type="button" class="btn btn-outline-danger fas fa-trash-alt" title="Eliminar"></button>

            <form id="download-form" method="POST" action="{% url 'tarifa_clientes_descargar_excel' %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-info fas fa-download" title="Descargar"></button>
            </form>

            <button id="save-button" class="btn btn-outline-success fas fa-save d-none" title="Guardar" type="button" onclick="saveRow();"></button>
            <button id="cancel-button" class="btn btn-outline-danger fas fa-times d-none" title="Cancelar" type="button" onclick="cancelEdit();"></button>
        </div>
    </div>

    <div class="card-footer text-muted">
        <div class="table-responsive table-app-wrap">
            <form id="delete-form" method="POST" action="{% url 'tarifa_clientes_eliminar' %}">
                {% csrf_token %}
                <table id="tarifa-table" class="table table-primary table-app">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>

                            <th data-sort="Cliente" class="sortable" data-direction="default">
                                Cliente
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="Linea" class="sortable" data-direction="default">
                                Linea
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="Modulo" class="sortable" data-direction="default">
                                Modulo
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="referencia" class="sortable" data-direction="default">
                                Referencia
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="centroCostos" class="sortable" data-direction="default">
                                Centro de costos
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="Anio" class="sortable" data-direction="default">
                                Año
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="Mes" class="sortable" data-direction="default">
                                Mes
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="sitioTrabajo" class="sortable" data-direction="default">
                                Sitio de trabajo
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="valorHora" class="sortable" data-direction="default">
                                Valor Hora
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="valorDia" class="sortable" data-direction="default">
                                Valor Día
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="valorMes" class="sortable" data-direction="default">
                                Valor Mes
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="bolsaMes" class="sortable" data-direction="default">
                                Cantidad Bolsa
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="valorBolsa" class="sortable" data-direction="default">
                                Valor bolsa
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="iva" class="sortable" data-direction="default">
                                IVA
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>

                            <th data-sort="moneda" class="sortable" data-direction="default">
                                Moneda
                                <span class="sort-icon">
                                    <i class="fas fa-sort sort-icon-default"></i>
                                    <i class="fas fa-sort-up sort-icon-asc"></i>
                                    <i class="fas fa-sort-down sort-icon-desc"></i>
                                </span>
                            </th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for tarifa in tarifa_clientes_data %}
                        <tr id="row-{{ tarifa.id }}" data-edit-url="{% url 'tarifa_clientes_editar' tarifa.id %}">
                            <td>
                                <input type="checkbox" class="row-select" name="items_to_delete" value="{{ tarifa.id }}">
                            </td>

                            <td data-field="Cliente" class="text-start" style="min-width:180px;">
                                <span class="form-control-plaintext">{{ tarifa.clienteId.Nombre_Cliente }}</span>
                                <input type="text" name="clienteId" class="form-control d-none" value="{{ tarifa.clienteId.Nombre_Cliente }}" readonly>
                            </td>

                            <td data-field="Linea" class="text-start" style="min-width:120px;">
                                <span class="form-control-plaintext">{{ tarifa.lineaId.Linea }}</span>
                                <input type="text" name="lineaId" class="form-control d-none" value="{{ tarifa.lineaId.Linea }}" readonly>
                            </td>

                            <td data-field="Modulo" class="text-start" style="min-width:150px;">
                                <span class="form-control-plaintext">{{ tarifa.moduloId.Modulo }}</span>
                                <input type="text" name="moduloId" class="form-control d-none" value="{{ tarifa.moduloId.Modulo }}" readonly>
                            </td>

                            {# ✅ Referencia #}
                            <td data-field="referencia" class="text-start" style="min-width:180px;">
                                <span class="form-control-plaintext" data-display="referencia">{{ tarifa.referenciaId.descripcionReferencia }}</span>
                                <select name="referencia" class="form-control d-none" data-selected="{{ tarifa.referenciaId.id }}" disabled></select>
                            </td>

                            {# ✅ CeCo #}
                            <td data-field="centroCostos" class="text-start" style="min-width:180px;">
                                <span class="form-control-plaintext" data-display="centroCostos">{{ tarifa.centrocostosId.descripcionCeCo }}</span>
                                <select name="centroCostos" class="form-control d-none" data-selected="{{ tarifa.centrocostosId.id }}" disabled></select>
                            </td>

                            <td data-field="Anio" class="text-start" style="min-width:80px;">
                                <span class="form-control-plaintext">{{ tarifa.anio }}</span>
                                <input type="text" name="anio" class="form-control d-none" value="{{ tarifa.anio }}" readonly>
                            </td>

                            <td data-field="Mes" class="text-start" style="min-width:50px;">
                                <span class="form-control-plaintext">{{ tarifa.mes }}</span>
                                <input type="text" name="mes" class="form-control d-none" value="{{ tarifa.mes }}" readonly>
                            </td>

                            {# ✅ Sitio trabajo (FIX: data-display) #}
                            <td data-field="sitioTrabajo" class="text-start">
                                <span class="form-control-plaintext" data-display="sitioTrabajo">{{ tarifa.sitioTrabajo }}</span>
                                <input type="text" name="sitioTrabajo" class="form-control d-none" value="{{ tarifa.sitioTrabajo }}" readonly>
                            </td>

                            {# ✅ Valores (FIX: data-display) #}
                            <td data-field="valorHora" class="text-end">
                                <span class="form-control-plaintext" data-display="valorHora">{{ tarifa.valorHora|currency_format }}</span>
                                <input type="text" name="valorHora" class="form-control d-none" value="{{ tarifa.valorHora|currency_format }}" readonly>
                            </td>

                            <td data-field="valorDia" class="text-end">
                                <span class="form-control-plaintext" data-display="valorDia">{{ tarifa.valorDia|currency_format }}</span>
                                <input type="text" name="valorDia" class="form-control d-none" value="{{ tarifa.valorDia|currency_format }}" readonly>
                            </td>

                            <td data-field="valorMes" class="text-end">
                                <span class="form-control-plaintext" data-display="valorMes">{{ tarifa.valorMes|currency_format }}</span>
                                <input type="text" name="valorMes" class="form-control d-none" value="{{ tarifa.valorMes|currency_format }}" readonly>
                            </td>

                            <td data-field="bolsaMes" class="text-end">
                                <span class="form-control-plaintext" data-display="bolsaMes">{{ tarifa.bolsaMes|currency_format }}</span>
                                <input type="text" name="bolsaMes" class="form-control d-none" value="{{ tarifa.bolsaMes|currency_format }}" readonly>
                            </td>

                            <td data-field="valorBolsa" class="text-end">
                                <span class="form-control-plaintext" data-display="valorBolsa">{{ tarifa.valorBolsa|currency_format }}</span>
                                <input type="text" name="valorBolsa" class="form-control d-none" value="{{ tarifa.valorBolsa|currency_format }}" readonly>
                            </td>

                            <td data-field="iva" class="text-end" style="min-width:80px;">
                                <span class="form-control-plaintext" data-display="iva">{{ tarifa.iva }}</span>
                                <input type="text" name="iva" class="form-control d-none" value="{{ tarifa.iva }}" readonly>
                            </td>

                            {# ✅ Moneda #}
                            <td data-field="moneda" class="text-start">
                                <span class="form-control-plaintext" data-display="moneda">{{ tarifa.monedaId.Nombre }}</span>
                                <select name="moneda" class="form-control d-none" data-selected="{{ tarifa.monedaId.id }}" disabled></select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>
        </div>
    </div>

    {# ✅ Templates de options (se renderizan 1 sola vez) #}
    <div class="d-none" aria-hidden="true">
        <select id="tpl-referencia">
            {% for ref in form.fields.referenciaId.queryset %}
                <option value="{{ ref.id }}">{{ ref.descripcionReferencia }}</option>
            {% endfor %}
        </select>

        <select id="tpl-centroCostos">
            {% for ceco in form.fields.centrocostosId.queryset %}
                <option value="{{ ceco.id }}">{{ ceco.descripcionCeCo }}</option>
            {% endfor %}
        </select>

        <select id="tpl-moneda">
            {% for moneda in form.fields.monedaId.queryset %}
                <option value="{{ moneda.id }}">{{ moneda.Nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Modal confirmación -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteLabel">Confirmar eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">¿Estás seguro de que deseas eliminar esta tarifa?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button id="confirm-delete-btn" type="button" class="btn btn-danger">Sí</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="{% static 'JS/TarifaClientes.js' %}"></script>
{% endblock %}
