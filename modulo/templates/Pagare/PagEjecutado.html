{% extends 'Base.html' %}
{% block contenido %}
<div class="card">
  <div class="card-body">
    <form method="POST">
      {% csrf_token %}

      <div class="row mb-4">
        <div class="col-md-6">
          <label>Seleccionar Actividades Ejecutadas:</label>

          <div class="dropdown">
            <button
              class="btn btn-secondary dropdown-toggle"
              type="button"
              id="dropdownActividadesEjecutado"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              Seleccionar actividades
            </button>

            <ul class="dropdown-menu" aria-labelledby="dropdownActividadesEjecutado">
              {% for actividad in todas_actividades %}
                <li>
                  <label class="dropdown-item">
                    <input
                      type="checkbox"
                      class="actividad-ejecutado-checkbox"
                      value="{{ actividad.Act_PagareId }}"
                      data-nombre="{{ actividad.Descripcion_Act }}"
                    >
                    {{ actividad.Descripcion_Act }}
                  </label>
                </li>
              {% endfor %}
            </ul>
          </div>

          <button type="button" class="btn btn-success mt-2" id="btn-agregar-ejecutado">
            <i class="fas fa-plus"></i> Agregar Actividad
          </button>
        </div>
      </div>

      <div class="table-responsive table-app-wrap">
      <table class="table table-bordered table-app">
        <thead>
          <tr>
            <th>Actividad</th>
            <th>Horas Ejecutadas</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody id="tabla-ejecutado">
          {% for ejecutado in pagare.pagareejecutado_set.all %}
            <tr data-actividad-id="{{ ejecutado.Actividad.Act_PagareId }}">
              <td>{{ ejecutado.Actividad.Descripcion_Act }}</td>
              <td>
                <input
                  type="number"
                  name="horas_ejecutadas_{{ ejecutado.Actividad.Act_PagareId }}"
                  value="{{ ejecutado.Horas_Ejecutadas }}"
                  class="form-control"
                  min="0"
                >
              </td>
              <td>
                <button type="button" class="btn btn-danger btn-eliminar-ejecutado">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          {% empty %}
            <tr class="text-muted">
              <td colspan="3" class="text-center">No hay actividadesזש ejecutadas.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>

      <button type="submit" class="btn btn-primary">Guardar Cambios</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const dropdown = document.getElementById('dropdownActividadesEjecutado');
  const btnAgregar = document.getElementById('btn-agregar-ejecutado');
  const checkboxes = Array.from(document.querySelectorAll('.actividad-ejecutado-checkbox'));
  const tabla = document.getElementById('tabla-ejecutado');

  function actualizarBotonDropdown() {
    const seleccionados = checkboxes
      .filter(cb => cb.checked)
      .map(cb => cb.parentElement.textContent.trim());

    dropdown.textContent = seleccionados.length
      ? seleccionados.join(', ')
      : 'Seleccionar actividades';
  }

  function crearFila(id, nombre) {
    const tr = document.createElement('tr');
    tr.setAttribute('data-actividad-id', id);
    tr.innerHTML = `
      <td>${nombre}</td>
      <td>
        <input type="number"
          name="horas_ejecutadas_${id}"
          value="0"
          class="form-control"
          min="0"
        >
      </td>
      <td>
        <button type="button" class="btn btn-danger btn-eliminar-ejecutado">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    return tr;
  }

  function agregarSeleccionadas() {
    const seleccionadas = checkboxes.filter(cb => cb.checked);

    seleccionadas.forEach(cb => {
      const id = cb.value;
      const nombre = cb.dataset.nombre || cb.parentElement.textContent.trim();
      const existe = tabla.querySelector(`tr[data-actividad-id="${id}"]`);
      if (!existe) {
        tabla.appendChild(crearFila(id, nombre));
      }
    });
  }

  checkboxes.forEach(cb => {
    cb.addEventListener('change', actualizarBotonDropdown);
  });

  btnAgregar.addEventListener('click', function () {
    agregarSeleccionadas();
  });

  tabla.addEventListener('click', function (e) {
    const btn = e.target.closest('.btn-eliminar-ejecutado');
    if (!btn) return;

    const row = btn.closest('tr');
    const id = row.getAttribute('data-actividad-id');

    const cb = checkboxes.find(x => x.value === id);
    if (cb) cb.checked = false;

    row.remove();
    actualizarBotonDropdown();
  });

  // Inicializar: marcar checks que ya existen en tabla
  Array.from(tabla.querySelectorAll('tr[data-actividad-id]')).forEach(row => {
    const id = row.getAttribute('data-actividad-id');
    const cb = checkboxes.find(x => x.value === id);
    if (cb) cb.checked = true;
  });

  actualizarBotonDropdown();
});
</script>
{% endblock %}
