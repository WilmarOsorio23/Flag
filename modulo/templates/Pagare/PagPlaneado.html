{% extends 'Base.html' %}
{% block contenido %}
<div class="card">
  <div class="card-body">
    <form method="POST">
      {% csrf_token %}

      <div class="row mb-4">
        <div class="col-md-6">
          <label>Seleccionar Actividades:</label>

          <div class="dropdown">
            <button
              class="btn btn-secondary dropdown-toggle"
              type="button"
              id="dropdownActividades"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              Seleccionar actividades
            </button>

            <ul class="dropdown-menu" aria-labelledby="dropdownActividades">
              {% for actividad in todas_actividades %}
                <li>
                  <label class="dropdown-item">
                    <input
                      type="checkbox"
                      class="actividad-checkbox"
                      value="{{ actividad.Act_PagareId }}"
                    >
                    {{ actividad.Descripcion_Act }}
                  </label>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

      <div class="table-responsive table-app-wrap">
      <table class="table table-bordered table-app">
        <thead>
          <tr>
            <th>Actividad</th>
            <th>Horas Planeadas</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody id="tabla-actividades">
          {% for planeado in pagare.pagareplaneado_set.all %}
            <tr data-actividad-id="{{ planeado.Actividad.Act_PagareId }}">
              <td>{{ planeado.Actividad.Descripcion_Act }}</td>
              <td>
                <input
                  type="number"
                  name="horas_planeadas_{{ planeado.Actividad.Act_PagareId }}"
                  value="{{ planeado.Horas_Planeadas }}"
                  class="form-control"
                  min="0"
                >
              </td>
              <td>
                <button type="button" class="btn btn-danger btn-eliminar">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          {% empty %}
            <tr class="text-muted">
              <td colspan="3" class="text-center">No hay actividades planeadas.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>

      <button type="submit" class="btn btn-primary">Guardar Cambios</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const dropdown = document.getElementById('dropdownActividades');
  const checkboxes = Array.from(document.querySelectorAll('.actividad-checkbox'));
  const tabla = document.getElementById('tabla-actividades');

  function actualizarBotonDropdown() {
    const seleccionados = checkboxes
      .filter(cb => cb.checked)
      .map(cb => cb.parentElement.textContent.trim());

    dropdown.textContent = seleccionados.length
      ? seleccionados.join(', ')
      : 'Seleccionar actividades';
  }

  function actualizarTabla() {
    const seleccionados = checkboxes
      .filter(cb => cb.checked)
      .map(cb => ({
        id: cb.value,
        nombre: cb.parentElement.textContent.trim()
      }));

    // eliminar filas no seleccionadas
    Array.from(tabla.querySelectorAll('tr[data-actividad-id]')).forEach(row => {
      const id = row.getAttribute('data-actividad-id');
      if (!seleccionados.some(a => a.id === id)) row.remove();
    });

    // agregar filas nuevas seleccionadas
    seleccionados.forEach(actividad => {
      const existe = tabla.querySelector(`tr[data-actividad-id="${actividad.id}"]`);
      if (!existe) {
        const tr = document.createElement('tr');
        tr.setAttribute('data-actividad-id', actividad.id);
        tr.innerHTML = `
          <td>${actividad.nombre}</td>
          <td>
            <input type="number"
              name="horas_planeadas_${actividad.id}"
              value="0"
              class="form-control"
              min="0"
            >
          </td>
          <td>
            <button type="button" class="btn btn-danger btn-eliminar">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tabla.appendChild(tr);
      }
    });
  }

  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      actualizarBotonDropdown();
      actualizarTabla();
    });
  });

  tabla.addEventListener('click', function (e) {
    const btn = e.target.closest('.btn-eliminar');
    if (!btn) return;

    const row = btn.closest('tr');
    const id = row.getAttribute('data-actividad-id');

    const checkbox = checkboxes.find(cb => cb.value === id);
    if (checkbox) checkbox.checked = false;

    row.remove();
    actualizarBotonDropdown();
  });

  // Inicializar: marcar checks que ya existen en tabla
  Array.from(tabla.querySelectorAll('tr[data-actividad-id]')).forEach(row => {
    const id = row.getAttribute('data-actividad-id');
    const cb = checkboxes.find(x => x.value === id);
    if (cb) cb.checked = true;
  });

  actualizarBotonDropdown();
});
</script>
{% endblock %}
